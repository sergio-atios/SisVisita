<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.8.0">
    <title>SisVisita - Administrador v1.8.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ec4899">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        body { font-family: system-ui; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); min-height: 100vh; }
        .card { background: rgba(30,41,59,0.8); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .nav-btn { padding: 0.5rem 1rem; transition: 0.3s; border-bottom: 3px solid transparent; cursor: pointer; }
        .nav-btn.active { color: #ec4899 !important; border-bottom-color: #ec4899; }
        .input { width: 100%; background: #1e293b; color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; }
        .input:focus { outline: none; border-color: #ec4899; }
        .hidden { display: none !important; }
        .residencia-item { transition: all 0.2s; cursor: move; }
        .residencia-item:hover { background-color: rgba(51, 65, 85, 0.8) !important; }
        .residencia-item.sortable-ghost { opacity: 0.4; }
        .residencia-item.sortable-drag { cursor: grabbing; }
        
        .search-container { position: relative; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; margin-top: 0.5rem; max-height: 300px; overflow-y: auto; z-index: 50; }
        .search-item { padding: 0.75rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-item:hover { background: rgba(236, 72, 153, 0.2); }
        .search-highlight { background: rgba(236, 72, 153, 0.3); border-radius: 0.25rem; padding: 0 0.25rem; }
        
        /* Timeline */
        .timeline-item { position: relative; padding-left: 2rem; padding-bottom: 1.5rem; }
        .timeline-item::before { content: ''; position: absolute; left: 0.375rem; top: 0; bottom: 0; width: 2px; background: rgba(236, 72, 153, 0.3); }
        .timeline-dot { position: absolute; left: 0; top: 0.25rem; width: 0.875rem; height: 0.875rem; border-radius: 50%; background: #ec4899; border: 2px solid #1e293b; }
    </style>
</head>
<body class="text-white p-4">
    
    <header class="card mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">üéØ SisVisita - Administrador</h1>
                <p class="text-gray-400">Vers√£o 1.8.0 - Fase 4 üöÄ</p>
            </div>
            
            <div class="flex gap-3">
                <!-- Busca Global -->
                <div class="search-container w-80">
                    <div class="relative">
                        <input type="text" id="buscaGlobal" class="input pr-10" placeholder="üîç Buscar...">
                        <button onclick="limparBusca()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="resultadosBusca" class="search-results hidden"></div>
                </div>
                
                <!-- Backup/Restore -->
                <button onclick="abrirModalBackup()" class="btn bg-purple-600 hover:bg-purple-700">
                    <i data-lucide="database"></i> Backup
                </button>
            </div>
        </div>
    </header>

    <nav class="card mb-6">
        <div class="flex gap-4 overflow-x-auto">
            <button onclick="navegarPara('dashboard')" class="nav-btn active text-gray-300">üìä Dashboard</button>
            <button onclick="navegarPara('territorios')" class="nav-btn text-gray-400">üìç Territ√≥rios</button>
            <button onclick="navegarPara('unidades')" class="nav-btn text-gray-400">üè¢ Unidades</button>
            <button onclick="navegarPara('designacao')" class="nav-btn text-gray-400">üéØ Designa√ß√£o</button>
            <button onclick="navegarPara('historico')" class="nav-btn text-gray-400">üìú Hist√≥rico</button>
        </div>
    </nav>

    <!-- Dashboard -->
    <section id="secao-dashboard">
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalTerritorios">0</div>
                    <div class="text-sm text-gray-400">Total Territ√≥rios</div>
                </div>
                <div class="bg-green-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalUnidades">0</div>
                    <div class="text-sm text-gray-400">Total Unidades</div>
                </div>
                <div class="bg-purple-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalResidencias">0</div>
                    <div class="text-sm text-gray-400">Total Resid√™ncias</div>
                </div>
                <div class="bg-orange-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalDesignados">0</div>
                    <div class="text-sm text-gray-400">Designados</div>
                </div>
            </div>
            
            <div class="bg-slate-700/30 p-4 rounded-lg">
                <h3 class="font-bold mb-3">üìä Estat√≠sticas Detalhadas</h3>
                <div id="estatisticasDetalhadas" class="space-y-2"></div>
            </div>
        </div>
    </section>

    <!-- Territ√≥rios -->
    <section id="secao-territorios" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Territ√≥rios</h2>
                <div class="flex gap-2">
                    <button onclick="abrirModalTerritorio()" class="btn bg-green-600 hover:bg-green-700">
                        <i data-lucide="plus"></i> Novo
                    </button>
                    <button onclick="gerarPacote()" class="btn bg-blue-600 hover:bg-blue-700">
                        <i data-lucide="package"></i> Gerar Pacote
                    </button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="bg-slate-700/30 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block mb-1 text-sm">Filtrar por Unidade</label>
                        <select id="filtroUnidade" onchange="aplicarFiltros()" class="input text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">Filtrar por Status</label>
                        <select id="filtroStatus" onchange="aplicarFiltros()" class="input text-sm">
                            <option value="">Todos</option>
                            <option value="disponivel">Dispon√≠vel</option>
                            <option value="designado">Designado</option>
                            <option value="trabalhando">Trabalhando</option>
                            <option value="concluido">Conclu√≠do</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">Ordenar por</label>
                        <select id="ordenacao" onchange="aplicarFiltros()" class="input text-sm">
                            <option value="nome">Nome</option>
                            <option value="id">ID</option>
                            <option value="progresso">Progresso</option>
                            <option value="residencias">Resid√™ncias</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="listaTerritorios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </section>

    <!-- Unidades -->
    <section id="secao-unidades" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Unidades</h2>
                <button onclick="abrirModalUnidade()" class="btn bg-green-600 hover:bg-green-700">
                    <i data-lucide="plus"></i> Nova Unidade
                </button>
            </div>
            <div id="listaUnidades" class="grid gap-4"></div>
        </div>
    </section>

    <!-- Designa√ß√£o -->
    <section id="secao-designacao" class="hidden">
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">üéØ Designa√ß√£o de Territ√≥rios</h2>
            
            <div class="bg-slate-700/30 p-4 rounded-lg mb-4">
                <h3 class="font-bold mb-3">Designar Territ√≥rio</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block mb-1 text-sm">Territ√≥rio</label>
                        <select id="designTerritorio" class="input text-sm">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">Executor</label>
                        <input type="text" id="designExecutor" class="input text-sm" placeholder="Nome do executor">
                    </div>
                    <div class="flex items-end">
                        <button onclick="designarTerritorio()" class="btn bg-green-600 hover:bg-green-700 w-full">
                            <i data-lucide="check"></i> Designar
                        </button>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="font-bold mb-3">Territ√≥rios Designados</h3>
                <div id="listaDesignados" class="space-y-3"></div>
            </div>
        </div>
    </section>

    <!-- Hist√≥rico -->
    <section id="secao-historico" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìú Hist√≥rico de Mudan√ßas</h2>
                <button onclick="limparHistorico()" class="btn bg-red-600 hover:bg-red-700">
                    <i data-lucide="trash-2"></i> Limpar
                </button>
            </div>
            
            <div id="listaHistorico" class="space-y-1"></div>
        </div>
    </section>

    <!-- Modal: Territ√≥rio -->
    <div id="modalTerritorio" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4" id="tituloModalTerr">Novo Territ√≥rio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 text-sm font-medium">Nome *</label>
                    <input type="text" id="terrNome" class="input" placeholder="Ex: Centro - Quadra 1">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">ID *</label>
                    <input type="text" id="terrID" class="input" placeholder="Ex: T001">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Unidade</label>
                    <select id="terrUnidade" class="input">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                
                <div class="bg-blue-900/20 p-4 rounded border border-blue-500/30">
                    <button onclick="abrirModalResidencias()" class="btn bg-blue-600 hover:bg-blue-700 w-full">
                        <i data-lucide="home"></i> Gerenciar Resid√™ncias (<span id="countResModal">0</span>)
                    </button>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="salvarTerritorio()" class="btn bg-green-600 hover:bg-green-700 flex-1">
                        <i data-lucide="save"></i> Salvar
                    </button>
                    <button onclick="fecharModal('modalTerritorio')" class="btn bg-gray-600 hover:bg-gray-700 flex-1">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Unidade -->
    <div id="modalUnidade" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-lg w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">Unidade</h3>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 text-sm font-medium">Nome *</label>
                    <input type="text" id="unidNome" class="input" placeholder="Ex: Unidade Norte">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Endere√ßo</label>
                    <input type="text" id="unidEndereco" class="input" placeholder="Ex: Rua A, 100">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Gestor</label>
                    <input type="text" id="unidGestor" class="input" placeholder="Ex: Jos√© Silva">
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="salvarUnidade()" class="btn bg-green-600 hover:bg-green-700 flex-1">
                        <i data-lucide="save"></i> Salvar
                    </button>
                    <button onclick="fecharModal('modalUnidade')" class="btn bg-gray-600 hover:bg-gray-700 flex-1">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Resid√™ncias -->
    <div id="modalResidencias" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">
                <i data-lucide="home"></i> Resid√™ncias do Territ√≥rio
            </h3>
            
            <div class="bg-slate-700/30 p-4 rounded-lg mb-4">
                <h4 class="font-bold mb-3">Adicionar Resid√™ncia <span class="text-sm text-gray-400">(Enter para adicionar)</span></h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block mb-1 text-sm">Logradouro *</label>
                        <input type="text" id="resLogradouro" class="input text-sm" placeholder="Ex: Rua A">
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">N√∫mero *</label>
                        <input type="text" id="resNumero" class="input text-sm" placeholder="Ex: 101">
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">Tipo</label>
                        <select id="resTipo" class="input text-sm">
                            <option>Casa</option>
                            <option>Apartamento</option>
                            <option>Comercial</option>
                            <option>Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block mb-1 text-sm">Complemento</label>
                        <input type="text" id="resComplemento" class="input text-sm" placeholder="Ex: Apto 201">
                    </div>
                </div>
                <button onclick="adicionarResidencia()" class="btn bg-green-600 hover:bg-green-700 mt-3 w-full">
                    <i data-lucide="plus"></i> Adicionar
                </button>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold">Resid√™ncias (<span id="countResidencias">0</span>)</h4>
                    <div class="text-sm text-gray-400">‚ÜïÔ∏è Arraste para reordenar</div>
                </div>
                <div id="listaResidenciasModal" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="fecharModalResidencias()" class="btn bg-green-600 hover:bg-green-700 flex-1">
                    <i data-lucide="check"></i> Concluir
                </button>
                <button onclick="fecharModal('modalResidencias')" class="btn bg-gray-600 hover:bg-gray-700">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Visualizar -->
    <div id="modalVisualizar" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">
                <i data-lucide="eye"></i> Visualizar Territ√≥rio
            </h3>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-slate-700/30 p-3 rounded">
                    <div class="text-sm text-gray-400">Nome</div>
                    <div class="font-bold" id="vizNome">-</div>
                </div>
                <div class="bg-slate-700/30 p-3 rounded">
                    <div class="text-sm text-gray-400">ID</div>
                    <div class="font-bold" id="vizID">-</div>
                </div>
                <div class="bg-slate-700/30 p-3 rounded">
                    <div class="text-sm text-gray-400">Unidade</div>
                    <div class="font-bold" id="vizUnidade">-</div>
                </div>
                <div class="bg-slate-700/30 p-3 rounded">
                    <div class="text-sm text-gray-400">Resid√™ncias</div>
                    <div class="font-bold text-blue-400" id="vizTotal">0</div>
                </div>
            </div>
            
            <div class="bg-slate-700/30 p-4 rounded mb-4">
                <h4 class="font-bold mb-3">Resid√™ncias por Logradouro</h4>
                <div id="vizResidencias" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="copiarTerritorioVisualizado()" class="btn bg-orange-600 hover:bg-orange-700 flex-1">
                    <i data-lucide="copy"></i> Copiar
                </button>
                <button onclick="baixarTerritorioVisualizado()" class="btn bg-blue-600 hover:bg-blue-700 flex-1">
                    <i data-lucide="download"></i> Download
                </button>
                <button onclick="editarTerritorioVisualizado()" class="btn bg-purple-600 hover:bg-purple-700 flex-1">
                    <i data-lucide="edit"></i> Editar
                </button>
                <button onclick="fecharModal('modalVisualizar')" class="btn bg-gray-600 hover:bg-gray-700">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Backup/Restore -->
    <div id="modalBackup" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-2xl w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">
                <i data-lucide="database"></i> Backup & Restore
            </h3>
            
            <div class="space-y-4">
                <!-- Backup -->
                <div class="bg-slate-700/30 p-4 rounded">
                    <h4 class="font-bold mb-3">üì§ Fazer Backup</h4>
                    <p class="text-sm text-gray-400 mb-3">Salvar todos os dados (territ√≥rios, unidades, hist√≥rico)</p>
                    <button onclick="fazerBackup()" class="btn bg-green-600 hover:bg-green-700 w-full">
                        <i data-lucide="download"></i> Baixar Backup
                    </button>
                </div>
                
                <!-- Restore -->
                <div class="bg-slate-700/30 p-4 rounded">
                    <h4 class="font-bold mb-3">üì• Restaurar Backup</h4>
                    <p class="text-sm text-gray-400 mb-3">Importar dados de um backup anterior</p>
                    <input type="file" id="arquivoBackup" accept=".json" class="hidden">
                    <button onclick="document.getElementById('arquivoBackup').click()" class="btn bg-blue-600 hover:bg-blue-700 w-full">
                        <i data-lucide="upload"></i> Selecionar Arquivo
                    </button>
                </div>
                
                <button onclick="fecharModal('modalBackup')" class="btn bg-gray-600 hover:bg-gray-700 w-full">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        let territorios = [];
        let unidades = [];
        let config = { administrador: '', regiao: '' };
        let residenciasTemp = [];
        let territorioEditando = null;
        let territorioVisualizando = null;
        let sortableInstance = null;
        let ultimoLogradouro = '';
        let historico = [];

        function salvarDados() {
            try {
                localStorage.setItem('sisVisita_territorios', JSON.stringify(territorios));
                localStorage.setItem('sisVisita_unidades', JSON.stringify(unidades));
                localStorage.setItem('sisVisita_config', JSON.stringify(config));
                localStorage.setItem('sisVisita_historico', JSON.stringify(historico));
                console.log('‚úÖ Dados salvos');
            } catch (e) {
                console.error('Erro ao salvar:', e);
                alert('‚ö†Ô∏è Erro ao salvar dados!');
            }
        }

        function carregarDados() {
            try {
                const terrData = localStorage.getItem('sisVisita_territorios');
                const unidData = localStorage.getItem('sisVisita_unidades');
                const confData = localStorage.getItem('sisVisita_config');
                const histData = localStorage.getItem('sisVisita_historico');
                
                if (terrData) territorios = JSON.parse(terrData);
                if (unidData) unidades = JSON.parse(unidData);
                if (confData) config = JSON.parse(confData);
                if (histData) historico = JSON.parse(histData);
                
                console.log(`üìä Carregados: ${territorios.length} territ√≥rios, ${unidades.length} unidades`);
            } catch (e) {
                console.error('Erro ao carregar:', e);
            }
        }

        // HIST√ìRICO
        function adicionarHistorico(acao, detalhes) {
            historico.unshift({
                id: Date.now(),
                data: new Date().toISOString(),
                acao,
                detalhes
            });
            
            // Manter apenas √∫ltimos 100 registros
            if (historico.length > 100) {
                historico = historico.slice(0, 100);
            }
            
            salvarDados();
        }

        function renderHistorico() {
            const container = document.getElementById('listaHistorico');
            
            if (historico.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhum registro no hist√≥rico</div>';
                return;
            }
            
            container.innerHTML = historico.map(h => {
                const data = new Date(h.data);
                const dataStr = data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="bg-slate-700/30 p-3 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold">${h.acao}</div>
                                    <div class="text-sm text-gray-400">${h.detalhes}</div>
                                </div>
                                <div class="text-xs text-gray-500">${dataStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function limparHistorico() {
            if (!confirm('‚ùå Tem certeza que deseja limpar todo o hist√≥rico?')) return;
            historico = [];
            salvarDados();
            renderHistorico();
            alert('‚úÖ Hist√≥rico limpo!');
        }

        function navegarPara(secao) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            
            const secaoEl = document.getElementById('secao-' + secao);
            if (secaoEl) {
                secaoEl.classList.remove('hidden');
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-400');
            });
            
            if (event && event.target) {
                event.target.classList.add('active');
                event.target.classList.remove('text-gray-400');
            }
            
            if (secao === 'dashboard') atualizarDashboard();
            if (secao === 'territorios') {
                aplicarFiltros();
                atualizarFiltroUnidades();
            }
            if (secao === 'unidades') renderUnidades();
            if (secao === 'designacao') {
                renderDesignacao();
                atualizarSelectDesignacao();
            }
            if (secao === 'historico') renderHistorico();
        }

        function atualizarDashboard() {
            document.getElementById('totalTerritorios').textContent = territorios.length;
            document.getElementById('totalUnidades').textContent = unidades.length;
            
            const totalRes = territorios.reduce((sum, t) => 
                sum + (t.residencias?.length || 0), 0);
            document.getElementById('totalResidencias').textContent = totalRes;
            
            const designados = territorios.filter(t => t.status === 'designado' || t.status === 'trabalhando').length;
            document.getElementById('totalDesignados').textContent = designados;
            
            const container = document.getElementById('estatisticasDetalhadas');
            
            if (territorios.length === 0) {
                container.innerHTML = '<div class="text-gray-400">Nenhum territ√≥rio cadastrado</div>';
                return;
            }
            
            const porUnidade = {};
            territorios.forEach(t => {
                const unid = t.unidades || 'Sem unidade';
                if (!porUnidade[unid]) {
                    porUnidade[unid] = { territorios: 0, residencias: 0, visitadas: 0 };
                }
                porUnidade[unid].territorios++;
                const totalRes = t.residencias?.length || 0;
                const visitadas = t.residencias?.filter(r => r.visitado).length || 0;
                porUnidade[unid].residencias += totalRes;
                porUnidade[unid].visitadas += visitadas;
            });
            
            container.innerHTML = Object.keys(porUnidade).map(unid => {
                const stats = porUnidade[unid];
                const perc = stats.residencias > 0 ? Math.round((stats.visitadas / stats.residencias) * 100) : 0;
                return `
                    <div class="bg-slate-600/30 p-3 rounded flex justify-between items-center">
                        <div>
                            <div class="font-bold">${unid}</div>
                            <div class="text-sm text-gray-400">
                                ${stats.territorios} territ√≥rios ‚Ä¢ ${stats.residencias} resid√™ncias ‚Ä¢ ${stats.visitadas} visitadas
                            </div>
                        </div>
                        <div class="text-2xl font-bold text-blue-400">${perc}%</div>
                    </div>
                `;
            }).join('');
        }

        // BUSCA GLOBAL
        document.addEventListener('DOMContentLoaded', function() {
            const inputBusca = document.getElementById('buscaGlobal');
            if (inputBusca) {
                inputBusca.addEventListener('input', function(e) {
                    const termo = e.target.value.trim().toLowerCase();
                    if (termo.length < 2) {
                        document.getElementById('resultadosBusca').classList.add('hidden');
                        return;
                    }
                    buscarTerritorios(termo);
                });
            }
            
            // AJUSTE: Enter nos campos de resid√™ncia
            const setupEnterKey = () => {
                ['resLogradouro', 'resNumero', 'resTipo', 'resComplemento'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                adicionarResidencia();
                            }
                        });
                    }
                });
            };
            
            // Configurar ao carregar
            setupEnterKey();
            
            // Backup listener
            const fileInput = document.getElementById('arquivoBackup');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        restaurarBackup(file);
                    }
                });
            }
        });

        function buscarTerritorios(termo) {
            const resultados = territorios.filter(t => {
                const matchNome = t.nome.toLowerCase().includes(termo);
                const matchID = t.territorio_id.toLowerCase().includes(termo);
                const matchLogradouros = t.residencias?.some(r => 
                    r.logradouro.toLowerCase().includes(termo)
                ) || false;
                return matchNome || matchID || matchLogradouros;
            });
            
            const container = document.getElementById('resultadosBusca');
            
            if (resultados.length === 0) {
                container.innerHTML = '<div class="search-item text-gray-400">Nenhum resultado encontrado</div>';
                container.classList.remove('hidden');
                return;
            }
            
            container.innerHTML = resultados.map(t => `
                <div class="search-item" onclick="abrirTerritorioRapido('${t.territorio_id}')">
                    <div class="font-bold">${destacarTermo(t.nome, termo)}</div>
                    <div class="text-sm text-gray-400">ID: ${destacarTermo(t.territorio_id, termo)}</div>
                </div>
            `).join('');
            
            container.classList.remove('hidden');
        }

        function destacarTermo(texto, termo) {
            const regex = new RegExp(`(${termo})`, 'gi');
            return texto.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function abrirTerritorioRapido(id) {
            limparBusca();
            navegarPara('territorios');
            setTimeout(() => visualizarTerritorio(id), 100);
        }

        function limparBusca() {
            document.getElementById('buscaGlobal').value = '';
            document.getElementById('resultadosBusca').classList.add('hidden');
        }

        function atualizarFiltroUnidades() {
            const select = document.getElementById('filtroUnidade');
            select.innerHTML = '<option value="">Todas</option>' +
                unidades.map(u => `<option value="${u.nome}">${u.nome}</option>`).join('');
        }

        function aplicarFiltros() {
            const unidade = document.getElementById('filtroUnidade').value;
            const status = document.getElementById('filtroStatus').value;
            const ordenacao = document.getElementById('ordenacao').value;
            
            let territoriosFiltrados = [...territorios];
            
            if (unidade) {
                territoriosFiltrados = territoriosFiltrados.filter(t => t.unidades === unidade);
            }
            
            if (status) {
                territoriosFiltrados = territoriosFiltrados.filter(t => t.status === status);
            }
            
            territoriosFiltrados.sort((a, b) => {
                if (ordenacao === 'nome') return a.nome.localeCompare(b.nome);
                if (ordenacao === 'id') return a.territorio_id.localeCompare(b.territorio_id);
                if (ordenacao === 'progresso') {
                    const percA = calcularPercentual(a);
                    const percB = calcularPercentual(b);
                    return percB - percA;
                }
                if (ordenacao === 'residencias') {
                    const resA = a.residencias?.length || 0;
                    const resB = b.residencias?.length || 0;
                    return resB - resA;
                }
                return 0;
            });
            
            renderTerritorios(territoriosFiltrados);
        }

        function calcularPercentual(territorio) {
            const total = territorio.residencias?.length || 0;
            if (total === 0) return 0;
            const visitadas = territorio.residencias.filter(r => r.visitado).length;
            return Math.round((visitadas / total) * 100);
        }

        function renderTerritorios(lista = territorios) {
            const container = document.getElementById('listaTerritorios');
            
            if (lista.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-8">
                        <i data-lucide="map-pin-off" class="w-16 h-16 mx-auto mb-2 opacity-50"></i>
                        <p>Nenhum territ√≥rio encontrado</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = lista.map(t => {
                const totalRes = t.residencias?.length || 0;
                const visitadas = t.residencias?.filter(r => r.visitado).length || 0;
                const perc = calcularPercentual(t);
                
                const statusColors = {
                    'disponivel': 'bg-green-900/30 text-green-400',
                    'designado': 'bg-yellow-900/30 text-yellow-400',
                    'trabalhando': 'bg-blue-900/30 text-blue-400',
                    'concluido': 'bg-purple-900/30 text-purple-400'
                };
                
                const statusTexts = {
                    'disponivel': 'Dispon√≠vel',
                    'designado': 'Designado',
                    'trabalhando': 'Trabalhando',
                    'concluido': 'Conclu√≠do'
                };
                
                const statusClass = statusColors[t.status] || statusColors['disponivel'];
                const statusText = statusTexts[t.status] || statusTexts['disponivel'];
                
                return `
                <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600 hover:border-slate-500 transition">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-lg">${t.nome}</h3>
                                <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
                            </div>
                            <div class="text-sm text-gray-400">ID: ${t.territorio_id}</div>
                            <div class="text-sm text-gray-400">Unidade: ${t.unidades || '<span class="text-yellow-400">N√£o definida</span>'}</div>
                            ${t.executor_atual ? `<div class="text-sm text-blue-400">Executor: ${t.executor_atual}</div>` : ''}
                            <div class="text-sm text-blue-400 mt-1">
                                üè† ${totalRes} resid√™ncias ‚Ä¢ ${visitadas} visitadas (${perc}%)
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="visualizarTerritorio('${t.territorio_id}')" class="btn bg-purple-600 hover:bg-purple-700 text-sm flex-1">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                        <button onclick="editarTerritorio('${t.territorio_id}')" class="btn bg-blue-600 hover:bg-blue-700 text-sm flex-1">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="copiarTerritorio('${t.territorio_id}')" class="btn bg-orange-600 hover:bg-orange-700 text-sm flex-1">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirTerritorio('${t.territorio_id}')" class="btn bg-red-600 hover:bg-red-700 text-sm flex-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');
            
            lucide.createIcons();
        }

        function abrirModalTerritorio() {
            document.getElementById('tituloModalTerr').textContent = 'Novo Territ√≥rio';
            document.getElementById('terrNome').value = '';
            document.getElementById('terrID').value = '';
            document.getElementById('terrID').disabled = false;
            
            const select = document.getElementById('terrUnidade');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                unidades.map(u => `<option value="${u.nome}">${u.nome}</option>`).join('');
            
            territorioEditando = null;
            residenciasTemp = [];
            ultimoLogradouro = '';
            document.getElementById('countResModal').textContent = '0';
            
            document.getElementById('modalTerritorio').classList.remove('hidden');
            lucide.createIcons();
        }

        function salvarTerritorio() {
            const nome = document.getElementById('terrNome').value.trim();
            const id = document.getElementById('terrID').value.trim();
            const unidade = document.getElementById('terrUnidade').value;
            
            if (!nome || !id) {
                alert('‚ö†Ô∏è Preencha nome e ID!');
                return;
            }
            
            if (!document.getElementById('terrID').disabled) {
                if (territorios.find(t => t.territorio_id === id)) {
                    alert('‚ö†Ô∏è J√° existe um territ√≥rio com este ID!');
                    return;
                }
                
                const total = residenciasTemp.length;
                const visitadas = residenciasTemp.filter(r => r.visitado).length;
                
                territorios.push({
                    territorio_id: id,
                    nome: nome,
                    unidades: unidade,
                    residencias: [...residenciasTemp],
                    status: 'disponivel',
                    executor_atual: null,
                    estatisticas: {
                        total_residencias: total,
                        visitadas: visitadas,
                        pendentes: total - visitadas,
                        percentual_conclusao: total > 0 ? Math.round((visitadas / total) * 100) : 0
                    }
                });
                
                adicionarHistorico('Territ√≥rio Criado', `${nome} (${id}) com ${total} resid√™ncias`);
                console.log(`‚úÖ Territ√≥rio ${id} criado com ${total} resid√™ncias`);
            } else {
                const index = territorios.findIndex(t => t.territorio_id === id);
                if (index !== -1) {
                    territorios[index].nome = nome;
                    territorios[index].unidades = unidade;
                    territorios[index].residencias = [...residenciasTemp];
                    
                    const total = residenciasTemp.length;
                    const visitadas = residenciasTemp.filter(r => r.visitado).length;
                    territorios[index].estatisticas = {
                        total_residencias: total,
                        visitadas: visitadas,
                        pendentes: total - visitadas,
                        percentual_conclusao: total > 0 ? Math.round((visitadas / total) * 100) : 0
                    };
                    
                    adicionarHistorico('Territ√≥rio Editado', `${nome} (${id}) - agora com ${total} resid√™ncias`);
                    console.log(`‚úÖ Territ√≥rio ${id} editado - agora tem ${total} resid√™ncias`);
                }
            }
            
            salvarDados();
            fecharModal('modalTerritorio');
            aplicarFiltros();
            residenciasTemp = [];
            ultimoLogradouro = '';
            territorioEditando = null;
            alert('‚úÖ Territ√≥rio salvo com sucesso!');
        }

        function editarTerritorio(id) {
            const t = territorios.find(terr => terr.territorio_id === id);
            if (!t) return;
            
            document.getElementById('tituloModalTerr').textContent = 'Editar Territ√≥rio';
            document.getElementById('terrNome').value = t.nome;
            document.getElementById('terrID').value = t.territorio_id;
            document.getElementById('terrID').disabled = true;
            
            const select = document.getElementById('terrUnidade');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                unidades.map(u => `<option value="${u.nome}" ${u.nome === t.unidades ? 'selected' : ''}>${u.nome}</option>`).join('');
            
            territorioEditando = id;
            residenciasTemp = t.residencias ? [...t.residencias] : [];
            ultimoLogradouro = residenciasTemp.length > 0 ? residenciasTemp[residenciasTemp.length - 1].logradouro : '';
            document.getElementById('countResModal').textContent = residenciasTemp.length;
            
            console.log(`üìù Editando territ√≥rio ${id} com ${residenciasTemp.length} resid√™ncias`);
            
            document.getElementById('modalTerritorio').classList.remove('hidden');
            lucide.createIcons();
        }

        function copiarTerritorio(id) {
            const t = territorios.find(terr => terr.territorio_id === id);
            if (!t) return;
            
            const novoID = prompt(`Copiar territ√≥rio ${t.nome}\n\nDigite o ID do novo territ√≥rio:`, t.territorio_id + '_copia');
            if (!novoID) return;
            
            if (territorios.find(x => x.territorio_id === novoID)) {
                alert('‚ö†Ô∏è ID j√° existe!');
                return;
            }
            
            const copia = JSON.parse(JSON.stringify(t));
            copia.territorio_id = novoID;
            copia.nome = t.nome + ' (C√≥pia)';
            copia.status = 'disponivel';
            copia.executor_atual = null;
            
            if (copia.residencias) {
                copia.residencias = copia.residencias.map(r => ({
                    ...r,
                    id: `res_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                }));
            }
            
            territorios.push(copia);
            adicionarHistorico('Territ√≥rio Copiado', `${copia.nome} (${novoID}) copiado de ${t.nome}`);
            salvarDados();
            aplicarFiltros();
            alert(`‚úÖ Territ√≥rio copiado!\n\nNovo ID: ${novoID}`);
        }

        function excluirTerritorio(id) {
            const t = territorios.find(terr => terr.territorio_id === id);
            if (!t) return;
            
            if (!confirm(`‚ùå Tem certeza que deseja excluir o territ√≥rio "${t.nome}"?`)) return;
            
            territorios = territorios.filter(t => t.territorio_id !== id);
            adicionarHistorico('Territ√≥rio Exclu√≠do', `${t.nome} (${id})`);
            salvarDados();
            aplicarFiltros();
            alert('‚úÖ Territ√≥rio exclu√≠do!');
        }

        // RESID√äNCIAS
        function abrirModalResidencias() {
            if (ultimoLogradouro) {
                document.getElementById('resLogradouro').value = ultimoLogradouro;
            }
            
            renderResidenciasModal();
            document.getElementById('modalResidencias').classList.remove('hidden');
            lucide.createIcons();
            
            setTimeout(() => document.getElementById('resNumero').focus(), 100);
        }

        function adicionarResidencia() {
            const logradouro = document.getElementById('resLogradouro').value.trim();
            const numero = document.getElementById('resNumero').value.trim();
            const tipo = document.getElementById('resTipo').value;
            const complemento = document.getElementById('resComplemento').value.trim();
            
            if (!logradouro || !numero) {
                alert('‚ö†Ô∏è Preencha logradouro e n√∫mero!');
                return;
            }
            
            residenciasTemp.push({
                id: `res_${Date.now()}`,
                logradouro,
                numero,
                tipo,
                complemento,
                visitado: false,
                data_visita: null,
                observacao: ''
            });
            
            ultimoLogradouro = logradouro;
            document.getElementById('resNumero').value = '';
            document.getElementById('resComplemento').value = '';
            document.getElementById('countResModal').textContent = residenciasTemp.length;
            
            renderResidenciasModal();
            document.getElementById('resNumero').focus();
        }

        function renderResidenciasModal() {
            const container = document.getElementById('listaResidenciasModal');
            document.getElementById('countResidencias').textContent = residenciasTemp.length;
            
            if (residenciasTemp.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">Nenhuma resid√™ncia adicionada</div>';
                return;
            }
            
            container.innerHTML = residenciasTemp.map((r, index) => `
                <div class="bg-slate-700/50 p-3 rounded flex justify-between items-center residencia-item" data-id="${index}">
                    <div class="flex items-center gap-3">
                        <span class="text-gray-400 cursor-grab">‚ò∞</span>
                        <div>
                            <div class="font-semibold">${r.logradouro}, ${r.numero}</div>
                            <div class="text-sm text-gray-400">${r.tipo}${r.complemento ? ' - ' + r.complemento : ''}</div>
                        </div>
                    </div>
                    <button onclick="removerResidencia(${index})" class="text-red-400 hover:text-red-300">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
            
            lucide.createIcons();
            
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            sortableInstance = Sortable.create(container, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.cursor-grab',
                onEnd: function(evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        const [removed] = residenciasTemp.splice(evt.oldIndex, 1);
                        residenciasTemp.splice(evt.newIndex, 0, removed);
                    }
                }
            });
        }

        function removerResidencia(index) {
            residenciasTemp.splice(index, 1);
            document.getElementById('countResModal').textContent = residenciasTemp.length;
            renderResidenciasModal();
        }

        function fecharModalResidencias() {
            fecharModal('modalResidencias');
        }

        function visualizarTerritorio(id) {
            const territorio = territorios.find(t => t.territorio_id === id);
            if (!territorio) return;
            
            territorioVisualizando = territorio;
            
            document.getElementById('vizNome').textContent = territorio.nome;
            document.getElementById('vizID').textContent = territorio.territorio_id;
            document.getElementById('vizUnidade').textContent = territorio.unidades || 'N√£o definida';
            document.getElementById('vizTotal').textContent = territorio.residencias?.length || 0;
            
            const container = document.getElementById('vizResidencias');
            
            if (!territorio.residencias || territorio.residencias.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400">Nenhuma resid√™ncia cadastrada</div>';
            } else {
                const porLogradouro = {};
                territorio.residencias.forEach(r => {
                    if (!porLogradouro[r.logradouro]) {
                        porLogradouro[r.logradouro] = [];
                    }
                    porLogradouro[r.logradouro].push(r);
                });
                
                container.innerHTML = Object.keys(porLogradouro).sort().map(log => {
                    const residencias = porLogradouro[log];
                    const visitadas = residencias.filter(r => r.visitado).length;
                    return `
                        <div class="bg-slate-600/30 p-3 rounded">
                            <div class="font-bold mb-2 flex justify-between">
                                <span>${log}</span>
                                <span class="text-sm text-gray-400">${visitadas}/${residencias.length}</span>
                            </div>
                            <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                                ${residencias.map(r => `
                                    <div class="text-center p-2 rounded text-sm ${r.visitado ? 'bg-green-900/30 text-green-400' : 'bg-slate-700 text-gray-300'}">
                                        ${r.numero}${r.complemento ? '*' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('modalVisualizar').classList.remove('hidden');
            lucide.createIcons();
        }

        function baixarTerritorioVisualizado() {
            if (!territorioVisualizando) return;
            
            const dataStr = JSON.stringify(territorioVisualizando, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `territorio_${territorioVisualizando.territorio_id}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Territ√≥rio exportado!');
        }

        function copiarTerritorioVisualizado() {
            if (!territorioVisualizando) return;
            fecharModal('modalVisualizar');
            copiarTerritorio(territorioVisualizando.territorio_id);
        }

        function editarTerritorioVisualizado() {
            if (!territorioVisualizando) return;
            fecharModal('modalVisualizar');
            editarTerritorio(territorioVisualizando.territorio_id);
        }

        // UNIDADES
        function renderUnidades() {
            const container = document.getElementById('listaUnidades');
            
            if (unidades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="building-2" class="w-16 h-16 mx-auto mb-2 opacity-50"></i>
                        <p>Nenhuma unidade cadastrada</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = unidades.map(u => `
                <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg">${u.nome}</h3>
                        ${u.endereco ? `<div class="text-sm text-gray-400">${u.endereco}</div>` : ''}
                        ${u.gestor ? `<div class="text-sm text-gray-400">Gestor: ${u.gestor}</div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editarUnidade('${u.nome}')" class="btn bg-blue-600 hover:bg-blue-700">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirUnidade('${u.nome}')" class="btn bg-red-600 hover:bg-red-700">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function abrirModalUnidade() {
            document.getElementById('unidNome').value = '';
            document.getElementById('unidNome').disabled = false;
            document.getElementById('unidEndereco').value = '';
            document.getElementById('unidGestor').value = '';
            document.getElementById('modalUnidade').classList.remove('hidden');
            lucide.createIcons();
        }

        function salvarUnidade() {
            const nome = document.getElementById('unidNome').value.trim();
            const endereco = document.getElementById('unidEndereco').value.trim();
            const gestor = document.getElementById('unidGestor').value.trim();
            
            if (!nome) {
                alert('‚ö†Ô∏è Informe o nome da unidade!');
                return;
            }
            
            if (!document.getElementById('unidNome').disabled) {
                if (unidades.find(u => u.nome === nome)) {
                    alert('‚ö†Ô∏è J√° existe uma unidade com este nome!');
                    return;
                }
                
                unidades.push({ nome, endereco, gestor });
                adicionarHistorico('Unidade Criada', `${nome}`);
            } else {
                const index = unidades.findIndex(u => u.nome === nome);
                if (index !== -1) {
                    unidades[index].endereco = endereco;
                    unidades[index].gestor = gestor;
                    adicionarHistorico('Unidade Editada', `${nome}`);
                }
            }
            
            salvarDados();
            fecharModal('modalUnidade');
            renderUnidades();
            atualizarFiltroUnidades();
            alert('‚úÖ Unidade salva com sucesso!');
        }

        function editarUnidade(nome) {
            const u = unidades.find(un => un.nome === nome);
            if (!u) return;
            
            document.getElementById('unidNome').value = u.nome;
            document.getElementById('unidNome').disabled = true;
            document.getElementById('unidEndereco').value = u.endereco || '';
            document.getElementById('unidGestor').value = u.gestor || '';
            document.getElementById('modalUnidade').classList.remove('hidden');
            lucide.createIcons();
        }

        function excluirUnidade(nome) {
            if (!confirm('‚ùå Tem certeza que deseja excluir esta unidade?')) return;
            
            unidades = unidades.filter(u => u.nome !== nome);
            adicionarHistorico('Unidade Exclu√≠da', `${nome}`);
            salvarDados();
            renderUnidades();
            atualizarFiltroUnidades();
            alert('‚úÖ Unidade exclu√≠da!');
        }

        // DESIGNA√á√ÉO
        function atualizarSelectDesignacao() {
            const select = document.getElementById('designTerritorio');
            const disponiveis = territorios.filter(t => t.status === 'disponivel');
            
            select.innerHTML = '<option value="">Selecione...</option>' +
                disponiveis.map(t => `<option value="${t.territorio_id}">${t.nome} (${t.territorio_id})</option>`).join('');
        }

        function designarTerritorio() {
            const terrId = document.getElementById('designTerritorio').value;
            const executor = document.getElementById('designExecutor').value.trim();
            
            if (!terrId || !executor) {
                alert('‚ö†Ô∏è Selecione territ√≥rio e executor!');
                return;
            }
            
            const terr = territorios.find(t => t.territorio_id === terrId);
            if (!terr) return;
            
            terr.status = 'designado';
            terr.executor_atual = executor;
            terr.data_designacao = new Date().toISOString();
            
            adicionarHistorico('Territ√≥rio Designado', `${terr.nome} para ${executor}`);
            salvarDados();
            
            document.getElementById('designTerritorio').value = '';
            document.getElementById('designExecutor').value = '';
            
            renderDesignacao();
            atualizarSelectDesignacao();
            alert('‚úÖ Territ√≥rio designado com sucesso!');
        }

        function renderDesignacao() {
            const container = document.getElementById('listaDesignados');
            const designados = territorios.filter(t => t.status === 'designado' || t.status === 'trabalhando');
            
            if (designados.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhum territ√≥rio designado</div>';
                return;
            }
            
            container.innerHTML = designados.map(t => `
                <div class="bg-slate-700/50 p-4 rounded border border-slate-600">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold">${t.nome} (${t.territorio_id})</h3>
                            <div class="text-sm text-gray-400">Executor: ${t.executor_atual}</div>
                            <div class="text-sm text-gray-400">Designado em: ${new Date(t.data_designacao).toLocaleDateString('pt-BR')}</div>
                        </div>
                        <button onclick="cancelarDesignacao('${t.territorio_id}')" class="btn bg-red-600 hover:bg-red-700 text-sm">
                            <i data-lucide="x" class="w-4 h-4"></i> Cancelar
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function cancelarDesignacao(id) {
            const terr = territorios.find(t => t.territorio_id === id);
            if (!terr) return;
            
            if (!confirm(`‚ùå Cancelar designa√ß√£o de "${terr.nome}"?`)) return;
            
            terr.status = 'disponivel';
            const executor = terr.executor_atual;
            terr.executor_atual = null;
            terr.data_designacao = null;
            
            adicionarHistorico('Designa√ß√£o Cancelada', `${terr.nome} (era ${executor})`);
            salvarDados();
            renderDesignacao();
            atualizarSelectDesignacao();
            alert('‚úÖ Designa√ß√£o cancelada!');
        }

        // BACKUP/RESTORE
        function abrirModalBackup() {
            document.getElementById('modalBackup').classList.remove('hidden');
            lucide.createIcons();
        }

        function fazerBackup() {
            const backup = {
                versao: '1.8.0',
                data: new Date().toISOString(),
                territorios,
                unidades,
                config,
                historico
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const dataAtual = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `sisvisita_backup_${dataAtual}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert(`‚úÖ Backup criado com sucesso!\n\nüì¶ ${territorios.length} territ√≥rios\nüè¢ ${unidades.length} unidades\nüìú ${historico.length} registros`);
        }

        function restaurarBackup(file) {
            if (!confirm('‚ö†Ô∏è Restaurar backup ir√° SUBSTITUIR todos os dados atuais.\n\nTem certeza?')) {
                document.getElementById('arquivoBackup').value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (backup.territorios) territorios = backup.territorios;
                    if (backup.unidades) unidades = backup.unidades;
                    if (backup.config) config = backup.config;
                    if (backup.historico) historico = backup.historico;
                    
                    salvarDados();
                    
                    adicionarHistorico('Backup Restaurado', `${territorios.length} territ√≥rios, ${unidades.length} unidades`);
                    
                    alert(`‚úÖ Backup restaurado com sucesso!\n\nüì¶ ${territorios.length} territ√≥rios\nüè¢ ${unidades.length} unidades\nüìú ${historico.length} registros`);
                    
                    window.location.reload();
                } catch (err) {
                    alert('‚ùå Erro ao ler arquivo de backup!\n\n' + err.message);
                }
                
                document.getElementById('arquivoBackup').value = '';
            };
            
            reader.readAsText(file);
        }

        function gerarPacote() {
            if (territorios.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° territ√≥rios cadastrados para gerar o pacote!');
                return;
            }
            
            const totalResidencias = territorios.reduce((sum, t) => sum + (t.residencias?.length || 0), 0);
            
            if (totalResidencias === 0) {
                if (!confirm('‚ö†Ô∏è Nenhum territ√≥rio tem resid√™ncias cadastradas.\n\nDeseja gerar mesmo assim?')) {
                    return;
                }
            }
            
            const pacote = {
                tipo: 'pacote_territorios',
                versao: '1.0',
                congregacao: config.administrador || 'Congrega√ß√£o',
                data_geracao: new Date().toISOString(),
                estatisticas: {
                    total_territorios: territorios.length,
                    total_residencias: totalResidencias,
                    total_unidades: unidades.length
                },
                territorios: territorios.map(t => ({
                    ...t,
                    status_local: 'disponivel',
                    executor_atual: null
                }))
            };
            
            const dataStr = JSON.stringify(pacote, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const dataAtual = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `pacote_territorios_${dataAtual}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            adicionarHistorico('Pacote Gerado', `${territorios.length} territ√≥rios, ${totalResidencias} resid√™ncias`);
            alert(`‚úÖ Pacote gerado com sucesso!\n\nüì¶ ${territorios.length} territ√≥rio(s)\nüè† ${totalResidencias} resid√™ncia(s)`);
        }

        function fecharModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('[App] Service Worker registrado');
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                if (confirm('üîÑ Nova vers√£o dispon√≠vel!\n\nDeseja atualizar agora?')) {
                                    newWorker.postMessage({ action: 'skipWaiting' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                })
                .catch(err => console.error('[App] Erro ao registrar SW:', err));
            
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ SisVisita Administrador v1.8.0 - Fase 4 carregado');
            carregarDados();
            atualizarDashboard();
            lucide.createIcons();
        });
    </script>
</body>
</html>
