<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.5.0">
    <title>SisVisita - Administrador v1.5.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ec4899">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: system-ui; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); min-height: 100vh; }
        .card { background: rgba(30,41,59,0.8); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:active { transform: scale(0.98); }
        .nav-btn { padding: 0.5rem 1rem; transition: 0.3s; border-bottom: 3px solid transparent; }
        .nav-btn.active { color: #ec4899 !important; border-bottom-color: #ec4899; }
        .input { width: 100%; background: #1e293b; color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; padding: 0.75rem; }
        .input:focus { outline: none; border-color: #ec4899; }
        .hidden { display: none !important; }
        .residencia-item { transition: all 0.2s; }
        .residencia-item:hover { background-color: rgba(51, 65, 85, 0.8) !important; }
    </style>
</head>
<body class="text-white p-4">
    
    <header class="card mb-6">
        <h1 class="text-3xl font-bold">üéØ SisVisita - Administrador</h1>
        <p class="text-gray-400">Vers√£o 1.5.0 - Fase 1</p>
    </header>

    <nav class="card mb-6">
        <div class="flex gap-4 overflow-x-auto">
            <button onclick="navegarPara('dashboard')" class="nav-btn active text-gray-300">üìä Dashboard</button>
            <button onclick="navegarPara('territorios')" class="nav-btn text-gray-400">üìç Territ√≥rios</button>
            <button onclick="navegarPara('unidades')" class="nav-btn text-gray-400">üè¢ Unidades</button>
        </div>
    </nav>

    <section id="secao-dashboard">
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalTerritorios">0</div>
                    <div class="text-sm text-gray-400">Total Territ√≥rios</div>
                </div>
                <div class="bg-green-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalUnidades">0</div>
                    <div class="text-sm text-gray-400">Total Unidades</div>
                </div>
                <div class="bg-purple-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalResidencias">0</div>
                    <div class="text-sm text-gray-400">Total Resid√™ncias</div>
                </div>
            </div>
        </div>
    </section>

    <section id="secao-territorios" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Territ√≥rios</h2>
                <div class="flex gap-2">
                    <button onclick="abrirModalTerritorio()" class="btn bg-green-600 hover:bg-green-700"><i data-lucide="plus"></i> Novo</button>
                    <button onclick="gerarPacote()" class="btn bg-blue-600 hover:bg-blue-700"><i data-lucide="package"></i> Gerar Pacote</button>
                </div>
            </div>
            <div id="listaTerritorios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </section>

    <section id="secao-unidades" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Unidades</h2>
                <button onclick="abrirModalUnidade()" class="btn bg-green-600 hover:bg-green-700"><i data-lucide="plus"></i> Nova Unidade</button>
            </div>
            <div id="listaUnidades" class="grid gap-4"></div>
        </div>
    </section>

    <!-- Modais aqui (por brevidade, vers√£o compacta) -->
    <div id="modalTerritorio" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onclick="fecharModal('modalTerritorio')">
        <div class="card max-w-2xl w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">Territ√≥rio</h3>
            <div class="space-y-4">
                <div><label class="block mb-2 text-sm">Nome *</label><input type="text" id="terrNome" class="input"></div>
                <div><label class="block mb-2 text-sm">ID *</label><input type="text" id="terrID" class="input"></div>
                <div><label class="block mb-2 text-sm">Unidade</label><select id="terrUnidade" class="input"></select></div>
                <div class="bg-blue-900/20 p-4 rounded border border-blue-500/30">
                    <button onclick="abrirModalResidencias()" class="btn bg-blue-600 hover:bg-blue-700 w-full"><i data-lucide="home"></i> Gerenciar Resid√™ncias (<span id="countResModal">0</span>)</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="salvarTerritorio()" class="btn bg-green-600 flex-1"><i data-lucide="save"></i> Salvar</button>
                    <button onclick="fecharModal('modalTerritorio')" class="btn bg-gray-600">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalUnidade" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onclick="fecharModal('modalUnidade')">
        <div class="card max-w-lg w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">Unidade</h3>
            <div class="space-y-4">
                <div><label class="block mb-2 text-sm">Nome *</label><input type="text" id="unidNome" class="input"></div>
                <div><label class="block mb-2 text-sm">Endere√ßo</label><input type="text" id="unidEndereco" class="input"></div>
                <div><label class="block mb-2 text-sm">Gestor</label><input type="text" id="unidGestor" class="input"></div>
                <div class="flex gap-2">
                    <button onclick="salvarUnidade()" class="btn bg-green-600 flex-1"><i data-lucide="save"></i> Salvar</button>
                    <button onclick="fecharModal('modalUnidade')" class="btn bg-gray-600">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalResidencias" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4"><i data-lucide="home"></i> Resid√™ncias do Territ√≥rio</h3>
            <div class="bg-slate-700/30 p-4 rounded-lg mb-4">
                <h4 class="font-bold mb-3">Adicionar Resid√™ncia</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div><label class="block mb-1 text-sm">Logradouro *</label><input type="text" id="resLogradouro" class="input text-sm"></div>
                    <div><label class="block mb-1 text-sm">N√∫mero *</label><input type="text" id="resNumero" class="input text-sm"></div>
                    <div><label class="block mb-1 text-sm">Tipo</label><select id="resTipo" class="input text-sm"><option>Casa</option><option>Apartamento</option><option>Comercial</option></select></div>
                    <div><label class="block mb-1 text-sm">Complemento</label><input type="text" id="resComplemento" class="input text-sm"></div>
                </div>
                <button onclick="adicionarResidencia()" class="btn bg-green-600 mt-3 w-full"><i data-lucide="plus"></i> Adicionar</button>
            </div>
            <div class="mb-4">
                <h4 class="font-bold mb-2">Resid√™ncias (<span id="countResidencias">0</span>)</h4>
                <div id="listaResidenciasModal" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="fecharModalResidencias()" class="btn bg-green-600 flex-1"><i data-lucide="check"></i> Concluir</button>
                <button onclick="fecharModal('modalResidencias')" class="btn bg-gray-600">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalVisualizar" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="card max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4"><i data-lucide="eye"></i> Visualizar Territ√≥rio</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-slate-700/30 p-3 rounded"><div class="text-sm text-gray-400">Nome</div><div class="font-bold" id="vizNome">-</div></div>
                <div class="bg-slate-700/30 p-3 rounded"><div class="text-sm text-gray-400">ID</div><div class="font-bold" id="vizID">-</div></div>
                <div class="bg-slate-700/30 p-3 rounded"><div class="text-sm text-gray-400">Unidade</div><div class="font-bold" id="vizUnidade">-</div></div>
                <div class="bg-slate-700/30 p-3 rounded"><div class="text-sm text-gray-400">Resid√™ncias</div><div class="font-bold text-blue-400" id="vizTotal">0</div></div>
            </div>
            <div class="bg-slate-700/30 p-4 rounded mb-4">
                <h4 class="font-bold mb-3">Resid√™ncias por Logradouro</h4>
                <div id="vizResidencias" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
            <div class="flex gap-2">
                <button onclick="baixarTerritorioVisualizado()" class="btn bg-blue-600 flex-1"><i data-lucide="download"></i> Download</button>
                <button onclick="editarTerritorioVisualizado()" class="btn bg-purple-600 flex-1"><i data-lucide="edit"></i> Editar</button>
                <button onclick="fecharModal('modalVisualizar')" class="btn bg-gray-600">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let territorios=[],unidades=[],config={administrador:'',regiao:''},residenciasTemp=[],territorioEditando=null,territorioVisualizando=null;
        function salvarDados(){try{localStorage.setItem('sisVisita_territorios',JSON.stringify(territorios));localStorage.setItem('sisVisita_unidades',JSON.stringify(unidades));localStorage.setItem('sisVisita_config',JSON.stringify(config))}catch(e){console.error('Erro:',e);alert('‚ö†Ô∏è Erro!')}}
        function carregarDados(){try{const t=localStorage.getItem('sisVisita_territorios'),u=localStorage.getItem('sisVisita_unidades'),c=localStorage.getItem('sisVisita_config');if(t)territorios=JSON.parse(t);if(u)unidades=JSON.parse(u);if(c)config=JSON.parse(c)}catch(e){console.error('Erro:',e)}}
        function navegarPara(s){document.querySelectorAll('section').forEach(x=>x.classList.add('hidden'));const el=document.getElementById('secao-'+s);if(el)el.classList.remove('hidden');document.querySelectorAll('.nav-btn').forEach(b=>{b.classList.remove('active');b.classList.add('text-gray-400')});if(event&&event.target){event.target.classList.add('active');event.target.classList.remove('text-gray-400')}if(s==='dashboard')atualizarDashboard();if(s==='territorios')renderTerritorios();if(s==='unidades')renderUnidades()}
        function atualizarDashboard(){document.getElementById('totalTerritorios').textContent=territorios.length;document.getElementById('totalUnidades').textContent=unidades.length;const r=territorios.reduce((s,t)=>s+(t.residencias?.length||0),0);document.getElementById('totalResidencias').textContent=r}
        function renderTerritorios(){const c=document.getElementById('listaTerritorios');if(territorios.length===0){c.innerHTML='<div class="col-span-full text-center text-gray-400 py-8"><p>Nenhum territ√≥rio cadastrado</p></div>';return}c.innerHTML=territorios.map(t=>{const tr=t.residencias?.length||0,v=t.residencias?.filter(r=>r.visitado).length||0,p=tr>0?Math.round((v/tr)*100):0;return`<div class="bg-slate-700/50 p-4 rounded-lg"><h3 class="font-bold">${t.nome}</h3><div class="text-sm text-gray-400">ID:${t.territorio_id}‚Ä¢Unidade:${t.unidades||'N/A'}</div><div class="text-sm text-blue-400">üè†${tr}‚Ä¢${v}visitadas(${p}%)</div><div class="flex gap-2 mt-3"><button onclick="visualizarTerritorio('${t.territorio_id}')"class="btn bg-purple-600 text-sm flex-1"><i data-lucide="eye"class="w-4 h-4"></i>Ver</button><button onclick="editarTerritorio('${t.territorio_id}')"class="btn bg-blue-600 text-sm flex-1"><i data-lucide="edit"class="w-4 h-4"></i>Editar</button><button onclick="excluirTerritorio('${t.territorio_id}')"class="btn bg-red-600 text-sm flex-1"><i data-lucide="trash-2"class="w-4 h-4"></i>Excluir</button></div></div>`}).join('');lucide.createIcons()}
        function abrirModalTerritorio(){document.getElementById('terrNome').value='';document.getElementById('terrID').value='';document.getElementById('terrID').disabled=false;const s=document.getElementById('terrUnidade');s.innerHTML='<option value="">Selecione...</option>'+unidades.map(u=>`<option value="${u.nome}">${u.nome}</option>`).join('');territorioEditando=null;residenciasTemp=[];document.getElementById('countResModal').textContent='0';document.getElementById('modalTerritorio').classList.remove('hidden');lucide.createIcons()}
        function salvarTerritorio(){const n=document.getElementById('terrNome').value.trim(),i=document.getElementById('terrID').value.trim(),u=document.getElementById('terrUnidade').value;if(!n||!i){alert('‚ö†Ô∏èPreencha!');return}if(!document.getElementById('terrID').disabled){if(territorios.find(t=>t.territorio_id===i)){alert('‚ö†Ô∏èID existe!');return}const to=residenciasTemp.length,vi=residenciasTemp.filter(r=>r.visitado).length;territorios.push({territorio_id:i,nome:n,unidades:u,residencias:[...residenciasTemp],status:'disponivel',estatisticas:{total_residencias:to,visitadas:vi,pendentes:to-vi,percentual_conclusao:to>0?Math.round((vi/to)*100):0}})}else{const ix=territorios.findIndex(t=>t.territorio_id===i);if(ix!==-1){territorios[ix].nome=n;territorios[ix].unidades=u}}salvarDados();fecharModal('modalTerritorio');renderTerritorios();residenciasTemp=[];alert('‚úÖSalvo!')}
        function editarTerritorio(i){const t=territorios.find(x=>x.territorio_id===i);if(!t)return;document.getElementById('terrNome').value=t.nome;document.getElementById('terrID').value=t.territorio_id;document.getElementById('terrID').disabled=true;const s=document.getElementById('terrUnidade');s.innerHTML='<option value="">Selecione...</option>'+unidades.map(u=>`<option value="${u.nome}"${u.nome===t.unidades?'selected':''}>${u.nome}</option>`).join('');territorioEditando=i;residenciasTemp=t.residencias?[...t.residencias]:[];document.getElementById('countResModal').textContent=residenciasTemp.length;document.getElementById('modalTerritorio').classList.remove('hidden');lucide.createIcons()}
        function excluirTerritorio(i){if(!confirm('‚ùåExcluir?'))return;territorios=territorios.filter(t=>t.territorio_id!==i);salvarDados();renderTerritorios();alert('‚úÖExclu√≠do!')}
        function abrirModalResidencias(){renderResidenciasModal();document.getElementById('modalResidencias').classList.remove('hidden');lucide.createIcons()}
        function adicionarResidencia(){const l=document.getElementById('resLogradouro').value.trim(),n=document.getElementById('resNumero').value.trim(),t=document.getElementById('resTipo').value,c=document.getElementById('resComplemento').value.trim();if(!l||!n){alert('‚ö†Ô∏èPreencha!');return}residenciasTemp.push({id:`res_${Date.now()}`,logradouro:l,numero:n,tipo:t,complemento:c,visitado:false,data_visita:null,observacao:''});document.getElementById('resLogradouro').value='';document.getElementById('resNumero').value='';document.getElementById('resComplemento').value='';document.getElementById('countResModal').textContent=residenciasTemp.length;renderResidenciasModal()}
        function renderResidenciasModal(){const c=document.getElementById('listaResidenciasModal');document.getElementById('countResidencias').textContent=residenciasTemp.length;if(residenciasTemp.length===0){c.innerHTML='<div class="text-center text-gray-400 py-4">Nenhuma resid√™ncia</div>';return}c.innerHTML=residenciasTemp.map((r,i)=>`<div class="bg-slate-700/50 p-3 rounded flex justify-between items-center"><div class="flex items-center gap-3"><span class="text-gray-400">‚ò∞</span><div><div class="font-semibold">${r.logradouro},${r.numero}</div><div class="text-sm text-gray-400">${r.tipo}${r.complemento?'-'+r.complemento:''}</div></div></div><button onclick="removerResidencia(${i})"class="text-red-400"><i data-lucide="trash-2"class="w-4 h-4"></i></button></div>`).join('');lucide.createIcons()}
        function removerResidencia(i){residenciasTemp.splice(i,1);document.getElementById('countResModal').textContent=residenciasTemp.length;renderResidenciasModal()}
        function fecharModalResidencias(){fecharModal('modalResidencias')}
        function visualizarTerritorio(i){const t=territorios.find(x=>x.territorio_id===i);if(!t)return;territorioVisualizando=t;document.getElementById('vizNome').textContent=t.nome;document.getElementById('vizID').textContent=t.territorio_id;document.getElementById('vizUnidade').textContent=t.unidades||'N/A';document.getElementById('vizTotal').textContent=t.residencias?.length||0;const c=document.getElementById('vizResidencias');if(!t.residencias||t.residencias.length===0){c.innerHTML='<div class="text-center text-gray-400">Sem resid√™ncias</div>'}else{const p={};t.residencias.forEach(r=>{if(!p[r.logradouro])p[r.logradouro]=[];p[r.logradouro].push(r)});c.innerHTML=Object.keys(p).sort().map(l=>{const rs=p[l],v=rs.filter(r=>r.visitado).length;return`<div class="bg-slate-600/30 p-3 rounded"><div class="font-bold mb-2 flex justify-between"><span>${l}</span><span class="text-sm text-gray-400">${v}/${rs.length}</span></div><div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">${rs.map(r=>`<div class="text-center p-2 rounded text-sm${r.visitado?' bg-green-900/30 text-green-400':' bg-slate-700 text-gray-300'}">${r.numero}${r.complemento?'*':''}</div>`).join('')}</div></div>`}).join('')}document.getElementById('modalVisualizar').classList.remove('hidden');lucide.createIcons()}
        function baixarTerritorioVisualizado(){if(!territorioVisualizando)return;const d=JSON.stringify(territorioVisualizando,null,2),b=new Blob([d],{type:'application/json'}),u=URL.createObjectURL(b),l=document.createElement('a');l.href=u;l.download=`territorio_${territorioVisualizando.territorio_id}.json`;l.click();URL.revokeObjectURL(u);alert('‚úÖExportado!')}
        function editarTerritorioVisualizado(){if(!territorioVisualizando)return;fecharModal('modalVisualizar');editarTerritorio(territorioVisualizando.territorio_id)}
        function renderUnidades(){const c=document.getElementById('listaUnidades');if(unidades.length===0){c.innerHTML='<div class="text-center text-gray-400 py-8"><p>Nenhuma unidade</p></div>';return}c.innerHTML=unidades.map(u=>`<div class="bg-slate-700/50 p-4 rounded-lg flex justify-between"><div><h3 class="font-bold">${u.nome}</h3>${u.endereco?`<div class="text-sm text-gray-400">${u.endereco}</div>`:''}${u.gestor?`<div class="text-sm text-gray-400">Gestor:${u.gestor}</div>`:''}</div><div class="flex gap-2"><button onclick="editarUnidade('${u.nome}')"class="btn bg-blue-600"><i data-lucide="edit"class="w-4 h-4"></i></button><button onclick="excluirUnidade('${u.nome}')"class="btn bg-red-600"><i data-lucide="trash-2"class="w-4 h-4"></i></button></div></div>`).join('');lucide.createIcons()}
        function abrirModalUnidade(){document.getElementById('unidNome').value='';document.getElementById('unidNome').disabled=false;document.getElementById('unidEndereco').value='';document.getElementById('unidGestor').value='';document.getElementById('modalUnidade').classList.remove('hidden');lucide.createIcons()}
        function salvarUnidade(){const n=document.getElementById('unidNome').value.trim(),e=document.getElementById('unidEndereco').value.trim(),g=document.getElementById('unidGestor').value.trim();if(!n){alert('‚ö†Ô∏èNome!');return}if(!document.getElementById('unidNome').disabled){if(unidades.find(u=>u.nome===n)){alert('‚ö†Ô∏èExiste!');return}unidades.push({nome:n,endereco:e,gestor:g})}else{const i=unidades.findIndex(u=>u.nome===n);if(i!==-1){unidades[i].endereco=e;unidades[i].gestor=g}}salvarDados();fecharModal('modalUnidade');renderUnidades();alert('‚úÖSalvo!')}
        function editarUnidade(n){const u=unidades.find(x=>x.nome===n);if(!u)return;document.getElementById('unidNome').value=u.nome;document.getElementById('unidNome').disabled=true;document.getElementById('unidEndereco').value=u.endereco||'';document.getElementById('unidGestor').value=u.gestor||'';document.getElementById('modalUnidade').classList.remove('hidden');lucide.createIcons()}
        function excluirUnidade(n){if(!confirm('‚ùåExcluir?'))return;unidades=unidades.filter(u=>u.nome!==n);salvarDados();renderUnidades();alert('‚úÖExclu√≠do!')}
        function gerarPacote(){if(territorios.length===0){alert('‚ö†Ô∏èSem territ√≥rios!');return}const r=territorios.reduce((s,t)=>s+(t.residencias?.length||0),0);if(r===0)if(!confirm('‚ö†Ô∏èSem resid√™ncias.\n\nGerar?'))return;const p={tipo:'pacote_territorios',versao:'1.0',congregacao:config.administrador||'Congrega√ß√£o',data_geracao:new Date().toISOString(),estatisticas:{total_territorios:territorios.length,total_residencias:r,total_unidades:unidades.length},territorios:territorios.map(t=>({...t,status_local:'disponivel',executor_atual:null}))},d=JSON.stringify(p,null,2),b=new Blob([d],{type:'application/json'}),u=URL.createObjectURL(b),l=document.createElement('a'),dt=new Date().toISOString().split('T')[0];l.href=u;l.download=`pacote_territorios_${dt}.json`;l.click();URL.revokeObjectURL(u);alert(`‚úÖPacote!\n\nüì¶${territorios.length}territ√≥rios\nüè†${r}resid√™ncias`)}
        function fecharModal(i){document.getElementById(i).classList.add('hidden')}
        if('serviceWorker'in navigator){navigator.serviceWorker.register('./service-worker.js').then(r=>{console.log('[SW]OK');r.addEventListener('updatefound',()=>{const w=r.installing;w.addEventListener('statechange',()=>{if(w.state==='installed'&&navigator.serviceWorker.controller)if(confirm('üîÑNova vers√£o!\n\nAtualizar?')){w.postMessage({action:'skipWaiting'});window.location.reload()}})})}).catch(e=>console.error('[SW]Erro:',e));let rf=false;navigator.serviceWorker.addEventListener('controllerchange',()=>{if(!rf){rf=true;window.location.reload()}})}
        document.addEventListener('DOMContentLoaded',function(){console.log('‚úÖv1.5.0-Fase 1');carregarDados();atualizarDashboard();lucide.createIcons()});
    </script>
</body>
</html>
