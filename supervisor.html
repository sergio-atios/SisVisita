<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisPorta - Supervisor</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ec4899">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SisPorta Super">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Biblioteca de Compartilhamento -->
    <script src="compartilhamento.js"></script>
    
    <style>
        :root {
            --color-vibrant-pink: #ec4899;
            --color-vibrant-cyan: #06b6d4;
            --color-vibrant-purple: #8b5cf6;
            --color-dark-bg: #0f172a;
            --color-dark-card: #1e293b;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-dark-bg);
            color: white;
            min-height: 100vh;
        }

        .abstract-blob-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 450px;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .abstract-blob-bg::before,
        .abstract-blob-bg::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.5;
            filter: blur(80px);
        }

        .abstract-blob-bg::before {
            width: 500px;
            height: 500px;
            top: -150px;
            left: -120px;
            background: radial-gradient(circle, var(--color-vibrant-pink) 0%, var(--color-vibrant-purple) 70%);
            animation: pulse-blob 10s infinite alternate;
        }

        .abstract-blob-bg::after {
            width: 420px;
            height: 420px;
            top: 60px;
            right: -100px;
            background: radial-gradient(circle, var(--color-vibrant-cyan) 0%, var(--color-dark-bg) 70%);
            animation: pulse-blob 12s infinite reverse;
        }

        @keyframes pulse-blob {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(5%, 5%); }
            100% { transform: scale(1) translate(0, 0); }
        }

        .card-neobrutal {
            background-color: var(--color-dark-card);
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .nav-btn {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-btn.active {
            border-bottom-color: var(--color-vibrant-cyan);
            color: var(--color-vibrant-cyan);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none;
        }

        .input-neobrutal {
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: white;
            width: 100%;
            transition: all 0.3s ease;
        }

        .input-neobrutal:focus {
            outline: none;
            border-color: var(--color-vibrant-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 1px solid rgba(236, 72, 153, 0.3);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-aguardando { background-color: rgba(234, 179, 8, 0.2); color: #facc15; }
        .badge-andamento { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-concluido { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .badge-parcial { background-color: rgba(251, 146, 60, 0.2); color: #fb923c; }
    </style>
</head>
<body>
    <!-- Background Abstrato -->
    <div class="abstract-blob-bg"></div>

    <!-- Container Principal -->
    <div class="container mx-auto px-4 py-6 max-w-7xl relative z-10">
        
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl font-bold text-white flex items-center gap-2">
                        <span class="text-5xl">üë®‚Äçüíº</span> SisPorta
                    </h1>
                    <p class="text-gray-400 text-sm">Supervisor Regional</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="exportarRelatorioCompleto()" class="btn-primary bg-gradient-to-r from-pink-500 to-purple-600 text-white flex items-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        Relat√≥rio Completo
                    </button>
                    <button onclick="abrirModalConfiguracoes()" class="btn-primary bg-slate-700 hover:bg-slate-600 text-white">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="card-neobrutal p-4 mb-6">
            <div class="flex gap-4 overflow-x-auto">
                <button onclick="navegarPara('dashboard')" class="nav-btn px-4 py-2 text-white font-semibold active">
                    üìä Dashboard
                </button>
                <button onclick="navegarPara('territorios')" class="nav-btn px-4 py-2 text-gray-400 font-semibold">
                    üìç Territ√≥rios
                </button>
                <button onclick="navegarPara('ubs')" class="nav-btn px-4 py-2 text-gray-400 font-semibold">
                    üè• UBS
                </button>
                <button onclick="navegarPara('relatorios')" class="nav-btn px-4 py-2 text-gray-400 font-semibold">
                    üìà Relat√≥rios
                </button>
            </div>
        </div>

        <!-- Se√ß√£o: Dashboard -->
        <section id="secao-dashboard" class="fade-in">
            <!-- Estat√≠sticas Gerais -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="stat-card rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold text-pink-400" id="dashTotalUBS">0</div>
                    <div class="text-sm text-gray-400">UBS Cadastradas</div>
                </div>
                <div class="stat-card rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold text-purple-400" id="dashTotalTerritorios">0</div>
                    <div class="text-sm text-gray-400">Territ√≥rios</div>
                </div>
                <div class="stat-card rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold text-cyan-400" id="dashTotalResidencias">0</div>
                    <div class="text-sm text-gray-400">Resid√™ncias</div>
                </div>
                <div class="stat-card rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold text-green-400" id="dashVisitadas">0</div>
                    <div class="text-sm text-gray-400">Visitadas</div>
                </div>
                <div class="stat-card rounded-lg p-6 text-center">
                    <div class="text-4xl font-bold text-blue-400" id="dashPercentual">0%</div>
                    <div class="text-sm text-gray-400">Progresso</div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card-neobrutal p-6">
                    <h3 class="text-xl font-bold text-white mb-4">üìä Status dos Territ√≥rios</h3>
                    <canvas id="graficoStatus"></canvas>
                </div>
                <div class="card-neobrutal p-6">
                    <h3 class="text-xl font-bold text-white mb-4">üìà Progresso por UBS</h3>
                    <canvas id="graficoUBS"></canvas>
                </div>
            </div>

            <!-- Territ√≥rios Cr√≠ticos -->
            <div class="card-neobrutal p-6">
                <h3 class="text-xl font-bold text-white mb-4">‚ö†Ô∏è Territ√≥rios que Precisam de Aten√ß√£o</h3>
                <div id="territoriosCriticos">
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        Nenhum territ√≥rio cr√≠tico no momento
                    </div>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o: Territ√≥rios -->
        <section id="secao-territorios" class="hidden fade-in">
            <div class="card-neobrutal p-6 mb-6">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-white">üìç Gerenciar Territ√≥rios</h2>
                    <div class="flex gap-3">
                        <button onclick="abrirModalNovoTerritorio()" class="btn-primary bg-gradient-to-r from-pink-500 to-purple-600 text-white flex items-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                            Novo Territ√≥rio
                        </button>
                        <label class="btn-primary bg-blue-600 hover:bg-blue-700 text-white cursor-pointer flex items-center gap-2">
                            <i data-lucide="upload" class="w-5 h-5"></i>
                            Importar
                            <input type="file" id="importarTerritorio" accept=".json" style="display: none;" onchange="importarTerritorio(event)">
                        </label>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="flex gap-3 mb-4 overflow-x-auto">
                    <button onclick="filtrarTerritorios('todos')" class="btn-filtro btn-primary bg-slate-600 text-white text-sm">
                        üìã Todos
                    </button>
                    <button onclick="filtrarTerritorios('aguardando_designacao')" class="btn-filtro btn-primary bg-yellow-600 text-white text-sm">
                        ‚è≥ Aguardando
                    </button>
                    <button onclick="filtrarTerritorios('em_andamento')" class="btn-filtro btn-primary bg-blue-600 text-white text-sm">
                        üîÑ Em Andamento
                    </button>
                    <button onclick="filtrarTerritorios('concluido')" class="btn-filtro btn-primary bg-green-600 text-white text-sm">
                        ‚úÖ Conclu√≠dos
                    </button>
                </div>
            </div>

            <!-- Lista de Territ√≥rios -->
            <div id="listaTerritorios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Territ√≥rios ser√£o inseridos aqui -->
            </div>
        </section>

        <!-- Se√ß√£o: UBS -->
        <section id="secao-ubs" class="hidden fade-in">
            <div class="card-neobrutal p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">üè• Gerenciar UBS</h2>
                    <button onclick="abrirModalNovaUBS()" class="btn-primary bg-gradient-to-r from-cyan-500 to-blue-600 text-white flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        Nova UBS
                    </button>
                </div>

                <div id="listaUBS" class="space-y-3">
                    <!-- UBS ser√£o inseridas aqui -->
                </div>
            </div>
        </section>

        <!-- Se√ß√£o: Relat√≥rios -->
        <section id="secao-relatorios" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Relat√≥rio por UBS -->
                <div class="card-neobrutal p-6">
                    <h3 class="text-xl font-bold text-white mb-4">üìä Relat√≥rio por UBS</h3>
                    <div id="relatorioUBS" class="space-y-3">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Relat√≥rio por Status -->
                <div class="card-neobrutal p-6">
                    <h3 class="text-xl font-bold text-white mb-4">üìà Relat√≥rio por Status</h3>
                    <div id="relatorioStatus" class="space-y-3">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                </div>

                <!-- Exporta√ß√µes -->
                <div class="card-neobrutal p-6 lg:col-span-2">
                    <h3 class="text-xl font-bold text-white mb-4">üì• Exporta√ß√µes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="exportarTodosPendentes()" class="btn-primary bg-yellow-600 hover:bg-yellow-700 text-white">
                            üì¶ Territ√≥rios Pendentes
                        </button>
                        <button onclick="exportarTodosAndamento()" class="btn-primary bg-blue-600 hover:bg-blue-700 text-white">
                            üîÑ Territ√≥rios em Andamento
                        </button>
                        <button onclick="exportarRelatorioCompleto()" class="btn-primary bg-pink-600 hover:bg-pink-700 text-white">
                            üìÑ Relat√≥rio Completo (JSON)
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal: Novo Territ√≥rio -->
        <div id="modalNovoTerritorio" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="fecharModal('modalNovoTerritorio')">
            <div class="card-neobrutal w-full max-w-4xl p-6 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold text-white mb-6">üìç Criar Novo Territ√≥rio</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-cyan-400">Informa√ß√µes B√°sicas</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Territ√≥rio *</label>
                            <input type="text" id="novoTerrNome" class="input-neobrutal" placeholder="Ex: Zona Norte - Rua Dom Pedro">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ID do Territ√≥rio *</label>
                            <input type="text" id="novoTerrID" class="input-neobrutal" placeholder="Ex: T001">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">UBS *</label>
                            <select id="novoTerrUBS" class="input-neobrutal">
                                <option value="">Selecione...</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Regi√£o/Bairro</label>
                            <input type="text" id="novoTerrRegiao" class="input-neobrutal" placeholder="Ex: Zona Norte">
                        </div>
                    </div>

                    <!-- Adicionar Resid√™ncias -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-cyan-400">Adicionar Resid√™ncias</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">CEP</label>
                            <input type="text" id="novaResCEP" class="input-neobrutal" placeholder="16900-000">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Logradouro *</label>
                            <input type="text" id="novaResLogradouro" class="input-neobrutal" placeholder="Rua Dom Pedro">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">N√∫mero *</label>
                                <input type="text" id="novaResNumero" class="input-neobrutal" placeholder="323">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Tipo</label>
                                <select id="novaResTipo" class="input-neobrutal">
                                    <option value="casa">Casa</option>
                                    <option value="apartamento">Apartamento</option>
                                    <option value="comercio">Com√©rcio</option>
                                    <option value="predio">Pr√©dio</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Complemento</label>
                            <input type="text" id="novaResComplemento" class="input-neobrutal" placeholder="Apto 101, Bloco A, etc">
                        </div>

                        <button onclick="adicionarResidencia()" class="btn-primary bg-green-600 hover:bg-green-700 text-white w-full">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                            Adicionar Resid√™ncia
                        </button>
                    </div>
                </div>

                <!-- Lista de Resid√™ncias Adicionadas -->
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-white mb-3">
                        Resid√™ncias Adicionadas (<span id="contadorResidencias">0</span>)
                    </h4>
                    <div id="listaResidenciasNovas" class="max-h-60 overflow-y-auto space-y-2">
                        <div class="text-center py-4 text-gray-400">
                            Nenhuma resid√™ncia adicionada ainda
                        </div>
                    </div>
                </div>

                <!-- Bot√µes -->
                <div class="flex gap-3 mt-6">
                    <button onclick="salvarNovoTerritorio()" class="btn-primary bg-gradient-to-r from-pink-500 to-purple-600 text-white flex-1">
                        üíæ Salvar Territ√≥rio
                    </button>
                    <button onclick="fecharModal('modalNovoTerritorio')" class="btn-primary bg-slate-700 hover:bg-slate-600 text-white flex-1">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal: Nova UBS -->
        <div id="modalNovaUBS" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="fecharModal('modalNovaUBS')">
            <div class="card-neobrutal w-full max-w-md p-6" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold text-white mb-4">üè• Adicionar UBS</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Nome da UBS *</label>
                        <input type="text" id="novaUBSNome" class="input-neobrutal" placeholder="Ex: UBS Central">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Endere√ßo</label>
                        <input type="text" id="novaUBSEndereco" class="input-neobrutal" placeholder="Rua, n√∫mero, bairro">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Coordenador Respons√°vel</label>
                        <input type="text" id="novaUBSCoordenador" class="input-neobrutal" placeholder="Nome do coordenador">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="salvarNovaUBS()" class="btn-primary bg-green-600 hover:bg-green-700 text-white flex-1">
                            Salvar
                        </button>
                        <button onclick="fecharModal('modalNovaUBS')" class="btn-primary bg-slate-700 hover:bg-slate-600 text-white flex-1">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Configura√ß√µes -->
        <div id="modalConfiguracoes" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="fecharModal('modalConfiguracoes')">
            <div class="card-neobrutal w-full max-w-md p-6" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold text-white mb-4">‚öôÔ∏è Configura√ß√µes</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Nome do Supervisor</label>
                        <input type="text" id="configSupervisor" class="input-neobrutal" placeholder="Seu nome">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Regi√£o</label>
                        <input type="text" id="configRegiao" class="input-neobrutal" placeholder="Ex: Regional Sul">
                    </div>

                    <div class="p-4 bg-red-900/20 border border-red-600 rounded-lg">
                        <h4 class="text-white font-semibold mb-2">‚ö†Ô∏è Zona de Perigo</h4>
                        <button onclick="limparTodosDados()" class="btn-primary bg-red-600 hover:bg-red-700 text-white w-full">
                            üóëÔ∏è Limpar Todos os Dados
                        </button>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="salvarConfiguracoes()" class="btn-primary bg-green-600 hover:bg-green-700 text-white flex-1">
                            Salvar
                        </button>
                        <button onclick="fecharModal('modalConfiguracoes')" class="btn-primary bg-slate-700 hover:bg-slate-600 text-white flex-1">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Vari√°veis Globais
        let territorios = [];
        let ubs = [];
        let config = {
            supervisor: '',
            regiao: ''
        };
        let residenciasNovas = [];
        let filtroAtual = 'todos';
        let graficos = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            
            // Registrar Service Worker (PWA)
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('service-worker.js');
                    console.log('Service Worker registrado');
                } catch (erro) {
                    console.log('Service Worker falhou:', erro);
                }
            }
            
            carregarDados();
            atualizarTodasInterfaces();
        });

        // === GEST√ÉO DE DADOS ===
        function carregarDados() {
            const territoriosSalvos = localStorage.getItem('sisPorta_super_territorios');
            const ubsSalvas = localStorage.getItem('sisPorta_super_ubs');
            const configSalva = localStorage.getItem('sisPorta_super_config');

            if (territoriosSalvos) territorios = JSON.parse(territoriosSalvos);
            if (ubsSalvas) ubs = JSON.parse(ubsSalvas);
            if (configSalva) config = JSON.parse(configSalva);
        }

        function salvarDados() {
            localStorage.setItem('sisPorta_super_territorios', JSON.stringify(territorios));
            localStorage.setItem('sisPorta_super_ubs', JSON.stringify(ubs));
            localStorage.setItem('sisPorta_super_config', JSON.stringify(config));
        }

        // === NAVEGA√á√ÉO ===
        function navegarPara(secao) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('secao-' + secao).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'text-white');
                btn.classList.add('text-gray-400');
            });

            event.target.classList.add('active', 'text-white');
            event.target.classList.remove('text-gray-400');

            if (secao === 'dashboard') atualizarDashboard();
            if (secao === 'territorios') atualizarListaTerritorios();
            if (secao === 'ubs') atualizarListaUBS();
            if (secao === 'relatorios') atualizarRelatorios();

            lucide.createIcons();
        }

        function atualizarTodasInterfaces() {
            atualizarDashboard();
            atualizarListaTerritorios();
            atualizarListaUBS();
            atualizarRelatorios();
            lucide.createIcons();
        }

        // === DASHBOARD ===
        function atualizarDashboard() {
            const totalUBS = ubs.length;
            const totalTerritorios = territorios.length;
            
            let totalResidencias = 0;
            let visitadas = 0;

            territorios.forEach(t => {
                totalResidencias += t.estatisticas.total_residencias;
                visitadas += t.estatisticas.visitadas;
            });

            const percentual = totalResidencias > 0 ? ((visitadas / totalResidencias) * 100).toFixed(1) : 0;

            document.getElementById('dashTotalUBS').textContent = totalUBS;
            document.getElementById('dashTotalTerritorios').textContent = totalTerritorios;
            document.getElementById('dashTotalResidencias').textContent = totalResidencias;
            document.getElementById('dashVisitadas').textContent = visitadas;
            document.getElementById('dashPercentual').textContent = percentual + '%';

            atualizarGraficos();
            atualizarTerritoriosCriticos();
        }

        function atualizarGraficos() {
            // Gr√°fico de Status
            const aguardando = territorios.filter(t => t.status === 'aguardando_designacao').length;
            const andamento = territorios.filter(t => t.status === 'em_andamento').length;
            const concluido = territorios.filter(t => t.status === 'concluido').length;
            const parcial = territorios.filter(t => t.status === 'parcialmente_concluido').length;

            if (graficos.status) graficos.status.destroy();
            
            const ctxStatus = document.getElementById('graficoStatus').getContext('2d');
            graficos.status = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Aguardando', 'Em Andamento', 'Conclu√≠do', 'Parcial'],
                    datasets: [{
                        data: [aguardando, andamento, concluido, parcial],
                        backgroundColor: ['#facc15', '#60a5fa', '#4ade80', '#fb923c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });

            // Gr√°fico por UBS
            const ubsLabels = ubs.map(u => u.nome);
            const ubsData = ubs.map(u => {
                const terrs = territorios.filter(t => t.ubs === u.nome);
                const total = terrs.reduce((sum, t) => sum + t.estatisticas.total_residencias, 0);
                const vis = terrs.reduce((sum, t) => sum + t.estatisticas.visitadas, 0);
                return total > 0 ? ((vis / total) * 100).toFixed(1) : 0;
            });

            if (graficos.ubs) graficos.ubs.destroy();
            
            const ctxUBS = document.getElementById('graficoUBS').getContext('2d');
            graficos.ubs = new Chart(ctxUBS, {
                type: 'bar',
                data: {
                    labels: ubsLabels,
                    datasets: [{
                        label: 'Progresso (%)',
                        data: ubsData,
                        backgroundColor: '#ec4899'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#fff' } },
                        x: { ticks: { color: '#fff' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
        }

        function atualizarTerritoriosCriticos() {
            const criticos = territorios.filter(t => 
                t.status === 'em_andamento' && 
                (new Date() - new Date(t.atualizado_em)) > 7 * 24 * 60 * 60 * 1000
            );

            const container = document.getElementById('territoriosCriticos');
            
            if (criticos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        Nenhum territ√≥rio cr√≠tico no momento
                    </div>
                `;
                return;
            }

            let html = '';
            criticos.forEach(t => {
                html += `
                    <div class="p-4 bg-orange-900/20 border border-orange-600 rounded-lg mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-white font-semibold">${t.nome}</div>
                                <div class="text-sm text-gray-400">UBS: ${t.ubs} ‚Ä¢ Agente: ${t.agente || 'N√£o designado'}</div>
                            </div>
                            <span class="text-orange-400 text-sm">‚ö†Ô∏è Sem atualiza√ß√£o h√° 7+ dias</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // === TERRIT√ìRIOS ===
        function abrirModalNovoTerritorio() {
            // Limpar campos
            document.getElementById('novoTerrNome').value = '';
            document.getElementById('novoTerrID').value = '';
            document.getElementById('novoTerrRegiao').value = '';
            document.getElementById('novaResCEP').value = '';
            document.getElementById('novaResLogradouro').value = '';
            document.getElementById('novaResNumero').value = '';
            document.getElementById('novaResComplemento').value = '';
            
            residenciasNovas = [];
            atualizarListaResidenciasNovas();

            // Preencher select de UBS
            const select = document.getElementById('novoTerrUBS');
            select.innerHTML = '<option value="">Selecione...</option>';
            ubs.forEach(u => {
                select.innerHTML += `<option value="${u.nome}">${u.nome}</option>`;
            });

            document.getElementById('modalNovoTerritorio').classList.remove('hidden');
        }

        function adicionarResidencia() {
            const logradouro = document.getElementById('novaResLogradouro').value.trim();
            const numero = document.getElementById('novaResNumero').value.trim();

            if (!logradouro || !numero) {
                alert('‚ö†Ô∏è Preencha Logradouro e N√∫mero!');
                return;
            }

            const residencia = {
                id: 'R' + Date.now(),
                cep: document.getElementById('novaResCEP').value.trim(),
                pais: 'Brasil',
                cidade: '',
                regiao: document.getElementById('novoTerrRegiao').value.trim(),
                logradouro: logradouro,
                numero: numero,
                tipo: document.getElementById('novaResTipo').value,
                complemento: document.getElementById('novaResComplemento').value.trim(),
                visitado: false,
                data_visita: null,
                nota: '',
                precisa_alteracao: false
            };

            residenciasNovas.push(residencia);
            atualizarListaResidenciasNovas();

            // Limpar apenas campos de resid√™ncia
            document.getElementById('novaResNumero').value = '';
            document.getElementById('novaResComplemento').value = '';
            document.getElementById('novaResNumero').focus();
        }

        function atualizarListaResidenciasNovas() {
            const container = document.getElementById('listaResidenciasNovas');
            document.getElementById('contadorResidencias').textContent = residenciasNovas.length;

            if (residenciasNovas.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        Nenhuma resid√™ncia adicionada ainda
                    </div>
                `;
                return;
            }

            let html = '';
            residenciasNovas.forEach((r, i) => {
                html += `
                    <div class="p-3 bg-slate-700/50 rounded-lg flex justify-between items-center">
                        <div>
                            <div class="text-white font-semibold">${r.logradouro}, ${r.numero}</div>
                            <div class="text-xs text-gray-400">${r.tipo}${r.complemento ? ' ‚Ä¢ ' + r.complemento : ''}</div>
                        </div>
                        <button onclick="removerResidencia(${i})" class="text-red-400 hover:text-red-300">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function removerResidencia(index) {
            residenciasNovas.splice(index, 1);
            atualizarListaResidenciasNovas();
        }

        function salvarNovoTerritorio() {
            const nome = document.getElementById('novoTerrNome').value.trim();
            const id = document.getElementById('novoTerrID').value.trim();
            const ubsNome = document.getElementById('novoTerrUBS').value;
            const regiao = document.getElementById('novoTerrRegiao').value.trim();

            if (!nome || !id || !ubsNome) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios (*)!');
                return;
            }

            if (residenciasNovas.length === 0) {
                alert('‚ö†Ô∏è Adicione pelo menos uma resid√™ncia!');
                return;
            }

            // Verificar se ID j√° existe
            if (territorios.find(t => t.territorio_id === id)) {
                alert('‚ö†Ô∏è J√° existe um territ√≥rio com este ID!');
                return;
            }

            const territorio = {
                tipo: 'territorio',
                versao: '1.0',
                territorio_id: id,
                nome: nome,
                ubs: ubsNome,
                coordenador: null,
                agente: null,
                status: 'aguardando_designacao',
                criado_em: new Date().toISOString(),
                atualizado_em: new Date().toISOString(),
                estatisticas: {
                    total_residencias: residenciasNovas.length,
                    visitadas: 0,
                    pendentes: residenciasNovas.length,
                    percentual_conclusao: 0
                },
                residencias: residenciasNovas
            };

            territorios.push(territorio);
            salvarDados();
            fecharModal('modalNovoTerritorio');
            atualizarTodasInterfaces();
            alert('‚úÖ Territ√≥rio criado com sucesso!');
        }

        function importarTerritorio(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (dados.tipo !== 'territorio') {
                        alert('‚ùå Arquivo inv√°lido!');
                        return;
                    }

                    const existe = territorios.find(t => t.territorio_id === dados.territorio_id);
                    if (existe) {
                        if (!confirm(`Territ√≥rio "${dados.nome}" j√° existe. Deseja substituir?`)) return;
                        territorios = territorios.filter(t => t.territorio_id !== dados.territorio_id);
                    }

                    territorios.push(dados);
                    salvarDados();
                    atualizarTodasInterfaces();
                    alert('‚úÖ Territ√≥rio importado com sucesso!');
                } catch (error) {
                    alert('‚ùå Erro ao ler arquivo: ' + error.message);
                }
            };
            reader.readAsText(arquivo);
            event.target.value = '';
        }

        function filtrarTerritorios(filtro) {
            filtroAtual = filtro;
            atualizarListaTerritorios();
        }

        function atualizarListaTerritorios() {
            const container = document.getElementById('listaTerritorios');
            
            let territoriosFiltrados = territorios;
            
            if (filtroAtual !== 'todos') {
                territoriosFiltrados = territorios.filter(t => t.status === filtroAtual);
            }

            if (territoriosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full card-neobrutal p-8 text-center">
                        <div class="text-6xl mb-4">üìç</div>
                        <h3 class="text-xl font-bold text-white mb-2">Nenhum Territ√≥rio</h3>
                        <p class="text-gray-400">Crie ou importe territ√≥rios para come√ßar.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            territoriosFiltrados.forEach(t => {
                html += `
                    <div class="card-neobrutal p-6 cursor-pointer hover:shadow-xl transition-all" onclick="exportarTerritorioIndividual('${t.territorio_id}')">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-white">${t.nome}</h3>
                            <span class="badge ${getBadgeClass(t.status)}">${getStatusText(t.status)}</span>
                        </div>
                        
                        <div class="text-sm text-gray-400 mb-3">
                            <div>ID: ${t.territorio_id}</div>
                            <div>UBS: ${t.ubs}</div>
                            ${t.agente ? `<div>Agente: ${t.agente}</div>` : ''}
                        </div>

                        <div class="grid grid-cols-3 gap-2 text-center text-xs mb-3">
                            <div>
                                <div class="text-white font-bold">${t.estatisticas.total_residencias}</div>
                                <div class="text-gray-400">Total</div>
                            </div>
                            <div>
                                <div class="text-green-400 font-bold">${t.estatisticas.visitadas}</div>
                                <div class="text-gray-400">Visitadas</div>
                            </div>
                            <div>
                                <div class="text-yellow-400 font-bold">${t.estatisticas.pendentes}</div>
                                <div class="text-gray-400">Pendentes</div>
                            </div>
                        </div>

                        <div class="bg-gray-700 rounded-full h-2 mb-3">
                            <div class="h-2 rounded-full bg-gradient-to-r from-pink-500 to-purple-500" style="width: ${t.estatisticas.percentual_conclusao}%"></div>
                        </div>

                        <button onclick="event.stopPropagation(); excluirTerritorio('${t.territorio_id}')" class="btn-primary bg-red-600 hover:bg-red-700 text-white text-sm w-full">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exportarTerritorioIndividual(territorioId) {
            const territorio = territorios.find(t => t.territorio_id === territorioId);
            if (!territorio) return;

            const dataStr = JSON.stringify(territorio, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `territorio_${territorio.territorio_id}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('‚úÖ Territ√≥rio exportado!');
        }

        function excluirTerritorio(territorioId) {
            const territorio = territorios.find(t => t.territorio_id === territorioId);
            if (!territorio) return;

            if (confirm(`‚ö†Ô∏è Tem certeza que deseja excluir "${territorio.nome}"?`)) {
                territorios = territorios.filter(t => t.territorio_id !== territorioId);
                salvarDados();
                atualizarTodasInterfaces();
                alert('‚úÖ Territ√≥rio exclu√≠do!');
            }
        }

        // === UBS ===
        function abrirModalNovaUBS() {
            document.getElementById('novaUBSNome').value = '';
            document.getElementById('novaUBSEndereco').value = '';
            document.getElementById('novaUBSCoordenador').value = '';
            document.getElementById('modalNovaUBS').classList.remove('hidden');
        }

        function salvarNovaUBS() {
            const nome = document.getElementById('novaUBSNome').value.trim();
            
            if (!nome) {
                alert('‚ö†Ô∏è Informe o nome da UBS!');
                return;
            }

            if (ubs.find(u => u.nome === nome)) {
                alert('‚ö†Ô∏è J√° existe uma UBS com este nome!');
                return;
            }

            ubs.push({
                nome: nome,
                endereco: document.getElementById('novaUBSEndereco').value.trim(),
                coordenador: document.getElementById('novaUBSCoordenador').value.trim()
            });

            salvarDados();
            fecharModal('modalNovaUBS');
            atualizarListaUBS();
            alert('‚úÖ UBS adicionada com sucesso!');
        }

        function atualizarListaUBS() {
            const container = document.getElementById('listaUBS');
            
            if (ubs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üè•</div>
                        Nenhuma UBS cadastrada
                    </div>
                `;
                return;
            }

            let html = '';
            ubs.forEach(u => {
                const terrs = territorios.filter(t => t.ubs === u.nome);
                html += `
                    <div class="p-4 bg-slate-700/50 rounded-lg flex justify-between items-center">
                        <div>
                            <div class="text-white font-semibold">${u.nome}</div>
                            ${u.endereco ? `<div class="text-sm text-gray-400">${u.endereco}</div>` : ''}
                            ${u.coordenador ? `<div class="text-sm text-gray-400">Coordenador: ${u.coordenador}</div>` : ''}
                            <div class="text-xs text-gray-500 mt-1">${terrs.length} territ√≥rio(s)</div>
                        </div>
                        <button onclick="excluirUBS('${u.nome}')" class="btn-primary bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-2">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function excluirUBS(nome) {
            const terrs = territorios.filter(t => t.ubs === nome);
            if (terrs.length > 0) {
                alert('‚ö†Ô∏è N√£o √© poss√≠vel excluir esta UBS pois existem territ√≥rios vinculados a ela!');
                return;
            }

            if (confirm(`‚ö†Ô∏è Tem certeza que deseja excluir "${nome}"?`)) {
                ubs = ubs.filter(u => u.nome !== nome);
                salvarDados();
                atualizarListaUBS();
                alert('‚úÖ UBS exclu√≠da!');
            }
        }

        // === RELAT√ìRIOS ===
        function atualizarRelatorios() {
            // Relat√≥rio por UBS
            const containerUBS = document.getElementById('relatorioUBS');
            let htmlUBS = '';
            
            ubs.forEach(u => {
                const terrs = territorios.filter(t => t.ubs === u.nome);
                const total = terrs.reduce((sum, t) => sum + t.estatisticas.total_residencias, 0);
                const vis = terrs.reduce((sum, t) => sum + t.estatisticas.visitadas, 0);
                const perc = total > 0 ? ((vis / total) * 100).toFixed(1) : 0;

                htmlUBS += `
                    <div class="p-4 bg-slate-700/50 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-white font-semibold">${u.nome}</div>
                            <div class="text-cyan-400 font-bold">${perc}%</div>
                        </div>
                        <div class="text-sm text-gray-400">
                            ${terrs.length} territ√≥rios ‚Ä¢ ${vis}/${total} resid√™ncias
                        </div>
                    </div>
                `;
            });

            containerUBS.innerHTML = htmlUBS || '<div class="text-center py-4 text-gray-400">Nenhuma UBS cadastrada</div>';

            // Relat√≥rio por Status
            const containerStatus = document.getElementById('relatorioStatus');
            const status = [
                { key: 'aguardando_designacao', label: '‚è≥ Aguardando Designa√ß√£o', color: 'yellow' },
                { key: 'em_andamento', label: 'üîÑ Em Andamento', color: 'blue' },
                { key: 'concluido', label: '‚úÖ Conclu√≠do', color: 'green' },
                { key: 'parcialmente_concluido', label: '‚ö†Ô∏è Parcialmente Conclu√≠do', color: 'orange' }
            ];

            let htmlStatus = '';
            status.forEach(s => {
                const count = territorios.filter(t => t.status === s.key).length;
                const perc = territorios.length > 0 ? ((count / territorios.length) * 100).toFixed(1) : 0;

                htmlStatus += `
                    <div class="p-4 bg-slate-700/50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div class="text-white font-semibold">${s.label}</div>
                            <div>
                                <span class="text-${s.color}-400 font-bold text-xl">${count}</span>
                                <span class="text-gray-400 text-sm ml-2">(${perc}%)</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            containerStatus.innerHTML = htmlStatus;
        }

        function exportarTodosPendentes() {
            const pendentes = territorios.filter(t => t.status === 'aguardando_designacao');
            
            if (pendentes.length === 0) {
                alert('‚ÑπÔ∏è N√£o h√° territ√≥rios pendentes para exportar.');
                return;
            }

            const dataStr = JSON.stringify(pendentes, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `territorios_pendentes_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert(`‚úÖ ${pendentes.length} territ√≥rio(s) pendente(s) exportado(s)!`);
        }

        function exportarTodosAndamento() {
            const andamento = territorios.filter(t => t.status === 'em_andamento');
            
            if (andamento.length === 0) {
                alert('‚ÑπÔ∏è N√£o h√° territ√≥rios em andamento para exportar.');
                return;
            }

            const dataStr = JSON.stringify(andamento, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `territorios_andamento_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert(`‚úÖ ${andamento.length} territ√≥rio(s) em andamento exportado(s)!`);
        }

        function exportarRelatorioCompleto() {
            const relatorio = {
                data_geracao: new Date().toISOString(),
                supervisor: config.supervisor,
                regiao: config.regiao,
                resumo: {
                    total_ubs: ubs.length,
                    total_territorios: territorios.length,
                    total_residencias: territorios.reduce((sum, t) => sum + t.estatisticas.total_residencias, 0),
                    total_visitadas: territorios.reduce((sum, t) => sum + t.estatisticas.visitadas, 0),
                    percentual_geral: territorios.length > 0 ? 
                        ((territorios.reduce((sum, t) => sum + t.estatisticas.visitadas, 0) / 
                          territorios.reduce((sum, t) => sum + t.estatisticas.total_residencias, 0)) * 100).toFixed(2) : 0
                },
                ubs: ubs,
                territorios: territorios
            };

            const dataStr = JSON.stringify(relatorio, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = `relatorio_completo_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('‚úÖ Relat√≥rio completo exportado!');
        }

        // === CONFIGURA√á√ïES ===
        function abrirModalConfiguracoes() {
            document.getElementById('configSupervisor').value = config.supervisor || '';
            document.getElementById('configRegiao').value = config.regiao || '';
            document.getElementById('modalConfiguracoes').classList.remove('hidden');
        }

        function salvarConfiguracoes() {
            config.supervisor = document.getElementById('configSupervisor').value.trim();
            config.regiao = document.getElementById('configRegiao').value.trim();
            
            salvarDados();
            fecharModal('modalConfiguracoes');
            alert('‚úÖ Configura√ß√µes salvas!');
        }

        function limparTodosDados() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO! Esta a√ß√£o ir√° excluir TODOS os dados.\n\nDeseja continuar?')) {
                if (confirm('‚ö†Ô∏è Tem CERTEZA ABSOLUTA? Esta a√ß√£o n√£o pode ser desfeita!')) {
                    localStorage.removeItem('sisPorta_super_territorios');
                    localStorage.removeItem('sisPorta_super_ubs');
                    localStorage.removeItem('sisPorta_super_config');
                    
                    territorios = [];
                    ubs = [];
                    config = { supervisor: '', regiao: '' };
                    
                    fecharModal('modalConfiguracoes');
                    atualizarTodasInterfaces();
                    alert('‚úÖ Todos os dados foram exclu√≠dos!');
                }
            }
        }

        // === UTILIDADES ===
        function getBadgeClass(status) {
            const classes = {
                'aguardando_designacao': 'badge-aguardando',
                'em_andamento': 'badge-andamento',
                'concluido': 'badge-concluido',
                'parcialmente_concluido': 'badge-parcial'
            };
            return classes[status] || 'badge-aguardando';
        }

        function getStatusText(status) {
            const textos = {
                'aguardando_designacao': '‚è≥ Aguardando',
                'em_andamento': 'üîÑ Andamento',
                'concluido': '‚úÖ Conclu√≠do',
                'parcialmente_concluido': '‚ö†Ô∏è Parcial'
            };
            return textos[status] || status;
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
    </script>
</body>
</html>
