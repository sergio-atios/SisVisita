<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.4.0">
    <title>SisVisita - Administrador</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ec4899">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- CSS/JS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: system-ui; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            min-height: 100vh;
        }
        .card { 
            background: rgba(30,41,59,0.8); 
            border-radius: 1rem; 
            padding: 1.5rem; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            transition: 0.2s; 
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:active { transform: scale(0.98); }
        .nav-btn { 
            padding: 0.5rem 1rem; 
            transition: 0.3s; 
            border-bottom: 3px solid transparent;
        }
        .nav-btn.active { 
            color: #ec4899 !important; 
            border-bottom-color: #ec4899; 
        }
        .input { 
            width: 100%; 
            background: #1e293b; 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 0.5rem; 
            padding: 0.75rem; 
        }
        .input:focus { 
            outline: none; 
            border-color: #ec4899; 
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="text-white p-4">
    
    <!-- Header -->
    <header class="card mb-6">
        <h1 class="text-3xl font-bold">üéØ SisVisita - Administrador</h1>
        <p class="text-gray-400">Vers√£o 1.4.0</p>
    </header>

    <!-- Navega√ß√£o -->
    <nav class="card mb-6">
        <div class="flex gap-4 overflow-x-auto">
            <button onclick="navegarPara('dashboard')" class="nav-btn active text-gray-300">
                üìä Dashboard
            </button>
            <button onclick="navegarPara('territorios')" class="nav-btn text-gray-400">
                üìç Territ√≥rios
            </button>
            <button onclick="navegarPara('unidades')" class="nav-btn text-gray-400">
                üè¢ Unidades
            </button>
        </div>
    </nav>

    <!-- Se√ß√£o: Dashboard -->
    <section id="secao-dashboard">
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalTerritorios">0</div>
                    <div class="text-sm text-gray-400">Total Territ√≥rios</div>
                </div>
                <div class="bg-green-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalUnidades">0</div>
                    <div class="text-sm text-gray-400">Total Unidades</div>
                </div>
                <div class="bg-purple-900/30 p-4 rounded-lg">
                    <div class="text-3xl font-bold" id="totalResidencias">0</div>
                    <div class="text-sm text-gray-400">Total Resid√™ncias</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Se√ß√£o: Territ√≥rios -->
    <section id="secao-territorios" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Territ√≥rios</h2>
                <div class="flex gap-2">
                    <button onclick="abrirModalTerritorio()" class="btn bg-green-600 hover:bg-green-700">
                        <i data-lucide="plus"></i> Novo
                    </button>
                    <button onclick="gerarPacote()" class="btn bg-blue-600 hover:bg-blue-700">
                        <i data-lucide="package"></i> Gerar Pacote
                    </button>
                </div>
            </div>
            <div id="listaTerritorios" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </section>

    <!-- Se√ß√£o: Unidades -->
    <section id="secao-unidades" class="hidden">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Unidades</h2>
                <button onclick="abrirModalUnidade()" class="btn bg-green-600 hover:bg-green-700">
                    <i data-lucide="plus"></i> Nova Unidade
                </button>
            </div>
            <div id="listaUnidades" class="grid gap-4"></div>
        </div>
    </section>

    <!-- Modal: Territ√≥rio -->
    <div id="modalTerritorio" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onclick="fecharModal('modalTerritorio')">
        <div class="card max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">Territ√≥rio</h3>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 text-sm font-medium">Nome *</label>
                    <input type="text" id="terrNome" class="input" placeholder="Ex: Centro - Quadra 1">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">ID *</label>
                    <input type="text" id="terrID" class="input" placeholder="Ex: T001">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Unidade</label>
                    <select id="terrUnidade" class="input">
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="salvarTerritorio()" class="btn bg-green-600 hover:bg-green-700 flex-1">
                        <i data-lucide="save"></i> Salvar
                    </button>
                    <button onclick="fecharModal('modalTerritorio')" class="btn bg-gray-600 hover:bg-gray-700 flex-1">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Unidade -->
    <div id="modalUnidade" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onclick="fecharModal('modalUnidade')">
        <div class="card max-w-lg w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4">Unidade</h3>
            <div class="space-y-4">
                <div>
                    <label class="block mb-2 text-sm font-medium">Nome *</label>
                    <input type="text" id="unidNome" class="input" placeholder="Ex: Unidade Norte">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Endere√ßo</label>
                    <input type="text" id="unidEndereco" class="input" placeholder="Ex: Rua A, 100">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium">Gestor</label>
                    <input type="text" id="unidGestor" class="input" placeholder="Ex: Jos√© Silva">
                </div>
                <div class="flex gap-2 pt-4">
                    <button onclick="salvarUnidade()" class="btn bg-green-600 hover:bg-green-700 flex-1">
                        <i data-lucide="save"></i> Salvar
                    </button>
                    <button onclick="fecharModal('modalUnidade')" class="btn bg-gray-600 hover:bg-gray-700 flex-1">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // VARI√ÅVEIS GLOBAIS
        // ========================================
        let territorios = [];
        let unidades = [];
        let config = { administrador: '', regiao: '' };

        // ========================================
        // ARMAZENAMENTO LOCAL
        // ========================================
        
        // Salvar dados no localStorage
        function salvarDados() {
            try {
                localStorage.setItem('sisVisita_territorios', JSON.stringify(territorios));
                localStorage.setItem('sisVisita_unidades', JSON.stringify(unidades));
                localStorage.setItem('sisVisita_config', JSON.stringify(config));
            } catch (e) {
                console.error('Erro ao salvar:', e);
                alert('‚ö†Ô∏è Erro ao salvar dados!');
            }
        }

        // Carregar dados do localStorage
        function carregarDados() {
            try {
                const terrData = localStorage.getItem('sisVisita_territorios');
                const unidData = localStorage.getItem('sisVisita_unidades');
                const confData = localStorage.getItem('sisVisita_config');
                
                if (terrData) territorios = JSON.parse(terrData);
                if (unidData) unidades = JSON.parse(unidData);
                if (confData) config = JSON.parse(confData);
            } catch (e) {
                console.error('Erro ao carregar:', e);
            }
        }

        // ========================================
        // NAVEGA√á√ÉO
        // ========================================
        
        function navegarPara(secao) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            
            // Mostrar se√ß√£o selecionada
            const secaoEl = document.getElementById('secao-' + secao);
            if (secaoEl) {
                secaoEl.classList.remove('hidden');
            }
            
            // Atualizar bot√µes de navega√ß√£o
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-400');
            });
            
            // Marcar bot√£o ativo
            if (event && event.target) {
                event.target.classList.add('active');
                event.target.classList.remove('text-gray-400');
            }
            
            // Atualizar conte√∫do
            if (secao === 'dashboard') atualizarDashboard();
            if (secao === 'territorios') renderTerritorios();
            if (secao === 'unidades') renderUnidades();
        }

        // ========================================
        // DASHBOARD
        // ========================================
        
        function atualizarDashboard() {
            document.getElementById('totalTerritorios').textContent = territorios.length;
            document.getElementById('totalUnidades').textContent = unidades.length;
            
            const totalRes = territorios.reduce((sum, t) => 
                sum + (t.residencias?.length || 0), 0);
            document.getElementById('totalResidencias').textContent = totalRes;
        }

        // ========================================
        // TERRIT√ìRIOS
        // ========================================
        
        function renderTerritorios() {
            const container = document.getElementById('listaTerritorios');
            
            if (territorios.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-8">
                        <i data-lucide="map-pin-off" class="w-16 h-16 mx-auto mb-2 opacity-50"></i>
                        <p>Nenhum territ√≥rio cadastrado</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = territorios.map(t => `
                <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600 hover:border-slate-500 transition">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg">${t.nome}</h3>
                            <div class="text-sm text-gray-400">ID: ${t.territorio_id}</div>
                            <div class="text-sm text-gray-400">
                                Unidade: ${t.unidades || '<span class="text-yellow-400">N√£o definida</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="editarTerritorio('${t.territorio_id}')" class="btn bg-blue-600 hover:bg-blue-700 text-sm flex-1">
                            <i data-lucide="edit" class="w-4 h-4"></i> Editar
                        </button>
                        <button onclick="excluirTerritorio('${t.territorio_id}')" class="btn bg-red-600 hover:bg-red-700 text-sm flex-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Excluir
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function abrirModalTerritorio() {
            // Limpar campos
            document.getElementById('terrNome').value = '';
            document.getElementById('terrID').value = '';
            document.getElementById('terrID').disabled = false;
            
            // Preencher select de unidades
            const select = document.getElementById('terrUnidade');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                unidades.map(u => `<option value="${u.nome}">${u.nome}</option>`).join('');
            
            // Abrir modal
            document.getElementById('modalTerritorio').classList.remove('hidden');
            lucide.createIcons();
        }

        function salvarTerritorio() {
            const nome = document.getElementById('terrNome').value.trim();
            const id = document.getElementById('terrID').value.trim();
            const unidade = document.getElementById('terrUnidade').value;
            
            if (!nome || !id) {
                alert('‚ö†Ô∏è Preencha nome e ID!');
                return;
            }
            
            // Verificar se j√° existe (ao criar novo)
            if (!document.getElementById('terrID').disabled) {
                if (territorios.find(t => t.territorio_id === id)) {
                    alert('‚ö†Ô∏è J√° existe um territ√≥rio com este ID!');
                    return;
                }
                
                // Criar novo
                territorios.push({
                    territorio_id: id,
                    nome: nome,
                    unidades: unidade,
                    residencias: [],
                    status: 'disponivel',
                    estatisticas: {
                        total_residencias: 0,
                        visitadas: 0,
                        pendentes: 0,
                        percentual_conclusao: 0
                    }
                });
            } else {
                // Editar existente
                const index = territorios.findIndex(t => t.territorio_id === id);
                if (index !== -1) {
                    territorios[index].nome = nome;
                    territorios[index].unidades = unidade;
                }
            }
            
            salvarDados();
            fecharModal('modalTerritorio');
            renderTerritorios();
            alert('‚úÖ Territ√≥rio salvo com sucesso!');
        }

        function editarTerritorio(id) {
            const t = territorios.find(terr => terr.territorio_id === id);
            if (!t) return;
            
            document.getElementById('terrNome').value = t.nome;
            document.getElementById('terrID').value = t.territorio_id;
            document.getElementById('terrID').disabled = true;
            
            const select = document.getElementById('terrUnidade');
            select.innerHTML = '<option value="">Selecione...</option>' + 
                unidades.map(u => `<option value="${u.nome}" ${u.nome === t.unidades ? 'selected' : ''}>${u.nome}</option>`).join('');
            
            document.getElementById('modalTerritorio').classList.remove('hidden');
            lucide.createIcons();
        }

        function excluirTerritorio(id) {
            if (!confirm('‚ùå Tem certeza que deseja excluir este territ√≥rio?')) return;
            
            territorios = territorios.filter(t => t.territorio_id !== id);
            salvarDados();
            renderTerritorios();
            alert('‚úÖ Territ√≥rio exclu√≠do!');
        }

        // ========================================
        // UNIDADES
        // ========================================
        
        function renderUnidades() {
            const container = document.getElementById('listaUnidades');
            
            if (unidades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i data-lucide="building-2" class="w-16 h-16 mx-auto mb-2 opacity-50"></i>
                        <p>Nenhuma unidade cadastrada</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = unidades.map(u => `
                <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-lg">${u.nome}</h3>
                        ${u.endereco ? `<div class="text-sm text-gray-400">${u.endereco}</div>` : ''}
                        ${u.gestor ? `<div class="text-sm text-gray-400">Gestor: ${u.gestor}</div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editarUnidade('${u.nome}')" class="btn bg-blue-600 hover:bg-blue-700">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="excluirUnidade('${u.nome}')" class="btn bg-red-600 hover:bg-red-700">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function abrirModalUnidade() {
            document.getElementById('unidNome').value = '';
            document.getElementById('unidNome').disabled = false;
            document.getElementById('unidEndereco').value = '';
            document.getElementById('unidGestor').value = '';
            document.getElementById('modalUnidade').classList.remove('hidden');
            lucide.createIcons();
        }

        function salvarUnidade() {
            const nome = document.getElementById('unidNome').value.trim();
            const endereco = document.getElementById('unidEndereco').value.trim();
            const gestor = document.getElementById('unidGestor').value.trim();
            
            if (!nome) {
                alert('‚ö†Ô∏è Informe o nome da unidade!');
                return;
            }
            
            if (!document.getElementById('unidNome').disabled) {
                // Verificar duplicata
                if (unidades.find(u => u.nome === nome)) {
                    alert('‚ö†Ô∏è J√° existe uma unidade com este nome!');
                    return;
                }
                
                // Criar nova
                unidades.push({ nome, endereco, gestor });
            } else {
                // Editar existente (n√£o implementado completamente)
                const index = unidades.findIndex(u => u.nome === nome);
                if (index !== -1) {
                    unidades[index].endereco = endereco;
                    unidades[index].gestor = gestor;
                }
            }
            
            salvarDados();
            fecharModal('modalUnidade');
            renderUnidades();
            alert('‚úÖ Unidade salva com sucesso!');
        }

        function editarUnidade(nome) {
            const u = unidades.find(un => un.nome === nome);
            if (!u) return;
            
            document.getElementById('unidNome').value = u.nome;
            document.getElementById('unidNome').disabled = true;
            document.getElementById('unidEndereco').value = u.endereco || '';
            document.getElementById('unidGestor').value = u.gestor || '';
            document.getElementById('modalUnidade').classList.remove('hidden');
            lucide.createIcons();
        }

        function excluirUnidade(nome) {
            if (!confirm('‚ùå Tem certeza que deseja excluir esta unidade?')) return;
            
            unidades = unidades.filter(u => u.nome !== nome);
            salvarDados();
            renderUnidades();
            alert('‚úÖ Unidade exclu√≠da!');
        }

        // ========================================
        // GERAR PACOTE
        // ========================================
        
        function gerarPacote() {
            if (territorios.length === 0) {
                alert('‚ö†Ô∏è N√£o h√° territ√≥rios cadastrados para gerar o pacote!');
                return;
            }
            
            const pacote = {
                tipo: 'pacote_territorios',
                versao: '1.0',
                congregacao: config.administrador || 'Congrega√ß√£o',
                data_geracao: new Date().toISOString(),
                territorios: territorios.map(t => ({
                    ...t,
                    status_local: 'disponivel',
                    executor_atual: null
                }))
            };
            
            const dataStr = JSON.stringify(pacote, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            const dataAtual = new Date().toISOString().split('T')[0];
            link.href = url;
            link.download = `pacote_territorios_${dataAtual}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert(`‚úÖ Pacote gerado com sucesso!\n\nüì¶ ${territorios.length} territ√≥rio(s) inclu√≠do(s).`);
        }

        // ========================================
        // UTILIT√ÅRIOS
        // ========================================
        
        function fecharModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ SisVisita Administrador v1.4.0 carregado');
            carregarDados();
            atualizarDashboard();
            lucide.createIcons();
        });
    </script>
</body>
</html>
